<!-- Sửa lỗi quản lý user không hiện thông tin của các user đi.



Làm cho khi admin bấm vào xem link đơn của khách hàng thì trình duyệt sẽ tải file đó trực tiếp về máy mà không cần phải xem file. Nếu có nhiều file thì sẽ có thể tải về hết tất cả các file đó.



Phần in tùy chọn khách có thể gửi nhiều file cùng lúc.



Fix lỗi bộ đếm trang không đếm file pdf.



Thêm nút quay lại khi user bấm vào tài liệu từ trang chủ hoặc bất kì chỗ nào.



Thêm tính năng đặt hàng lại trong phần xem của lịch sử in.



Fix lỗi khi lưu thay đổi chỉnh sửa thì popup không tự tắt, hệ thống báo _ is not defined nhưng vẫn cập nhật được =)  -->

<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dienkon In Ấn Mọi Thứ</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải thư viện SheetJS (xlsx) để xuất Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <!-- Tải Cloudinary Widget -->
    <script
      src="https://widget.cloudinary.com/v2.0/global/all.js"
      type="text/javascript"
    ></script>

    <style>
      /* Thêm font Inter cho đẹp */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Style cho view đang ẩn */
      .view {
        display: none;
      }
      /* Style cho view đang active */
      .view.active {
        display: block;
      }
      /* Hiệu ứng loading */
      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Style cho nút bị disabled */
      button:disabled,
      button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
      /* Style cho menu mobile */
      #mobile-menu {
        transition: transform 0.3s ease-in-out;
      }
      #mobile-menu.open {
        transform: translateX(0);
      }
      #mobile-menu.closed {
        transform: translateX(100%);
      }
    </style>
    <!-- Tải font Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-100">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="view">
      <div class="spinner"></div>
    </div>

    <!-- Thanh Điều Hướng (Navbar) - ĐÃ SỬA -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <!-- Logo -->
          <div class="flex-shrink-0 flex items-center">
            <span class="text-2xl font-bold text-blue-600">DienkonPrint
          </div>

          <!-- Nav Links (Desktop) -->
          <div class="hidden sm:flex sm:items-center sm:space-x-4">
            <button
              data-view="home-view"
              class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
            >
              Trang Chủ
            </button>
            <button
              data-view="quick-print-view"
              class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
            >
              In Nhanh
            </button>
            <button
              data-view="custom-order-view"
              class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
            >
              Tải File In
            </button>
            <button
              data-view="history-view"
              class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium"
            >
              Lịch Sử In
            </button>
            <button
              data-view="admin-view"
              id="admin-nav-link"
              class="nav-link text-red-500 hover:text-red-700 px-3 py-2 rounded-md text-sm font-medium hidden"
            >
              Quản Trị
            </button>

            <!-- User Info (Desktop) -->
            <div
              id="user-info-desktop"
              class="flex items-center space-x-2 text-sm pl-4 border-l border-gray-200"
            >
              <div>
                <span id="user-name-display" class="font-medium block"></span>
                <span
                  id="user-class-display"
                  class="text-gray-600 block"
                ></span>
              </div>
              <span
                id="user-balance-display"
                class="bg-green-100 text-green-800 px-2 py-1 rounded-full font-bold"
              ></span>
            </div>

            <!-- THAY ĐỔI: Nút đăng nhập cho khách (Desktop) -->
            <button
              id="login-nav-link"
              data-view="login-view"
              class="nav-link hidden text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium pl-4 border-l border-gray-200"
            >
              Khách (Đăng Nhập)
            </button>
            <!-- KẾT THÚC THAY ĐỔI -->
          </div>

          <!-- Hamburger Toggle (Mobile) -->
          <div class="flex sm:hidden">
            <button
              id="menu-toggle"
              class="text-gray-500 hover:text-gray-700 focus:outline-none"
            >
              <svg
                class="h-6 w-6"
                stroke="currentColor"
                fill="none"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Mobile Menu (Slide-in from right) -->
      <div
        id="mobile-menu"
        class="closed fixed top-0 right-0 h-full w-64 bg-white shadow-lg z-[60] p-4"
      >
        <!-- Close Button -->
        <div class="flex justify-end mb-4">
          <button
            id="menu-close"
            class="text-gray-500 hover:text-gray-700 focus:outline-none"
          >
            <svg
              class="h-6 w-6"
              stroke="currentColor"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              />
            </svg>
          </button>
        </div>

        <!-- Links (Vertical) -->
        <div class="flex flex-col space-y-2">
          <!-- User Info (Mobile) -->
          <div
            id="user-info-mobile"
            class="flex flex-col items-start space-y-1 text-sm p-3 bg-gray-50 rounded-lg mb-4"
          >
            <span id="user-name-display-mobile" class="font-medium"></span>
            <span id="user-class-display-mobile" class="text-gray-600"></span>
            <span
              id="user-balance-display-mobile"
              class="bg-green-100 text-green-800 px-2 py-1 rounded-full font-bold"
            ></span>
          </div>

          <!-- THAY ĐỔI: Nút đăng nhập cho khách (Mobile) -->
          <button
            id="login-nav-link-mobile"
            data-view="login-view"
            class="nav-link hidden text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium text-left bg-gray-50 mb-4"
          >
            Khách (Đăng Nhập)
          </button>
          <!-- KẾT THÚC THAY ĐỔI -->

          <button
            data-view="home-view"
            class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium text-left"
          >
            Trang Chủ
          </button>
          <button
            data-view="quick-print-view"
            class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium text-left"
          >
            In Nhanh
          </button>
          <button
            data-view="custom-order-view"
            class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium text-left"
          >
            Tải File In
          </button>
          <button
            data-view="history-view"
            class="nav-link text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-base font-medium text-left"
          >
            Lịch Sử In
          </button>
          <button
            data-view="admin-view"
            id="admin-nav-link-mobile"
            class="nav-link text-red-500 hover:text-red-700 px-3 py-2 rounded-md text-base font-medium hidden text-left"
          >
            Quản Trị
          </button>
        </div>
      </div>
      <!-- Overlay -->
      <div
        id="menu-overlay"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-[59]"
      ></div>
    </nav>
    <!-- KẾT THÚC: Thanh Điều Hướng (Navbar) -->

    <!-- Nội dung chính của ứng dụng -->
    <main id="app" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
      <!-- View: Đăng Nhập (Chỉ hiện khi chưa có thông tin) -->
      <!-- THAY ĐỔI: Sẽ không active mặc định, chỉ active khi được gọi -->
      <div id="login-view" class="view">
        <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg mt-10">
          <h2 class="text-2xl font-bold text-center mb-6">
            Thông Tin Người Dùng
          </h2>
          <p class="text-center text-gray-600 mb-6">
            Vui lòng nhập Họ Tên và Lớp để sử dụng các chức năng in ấn.
          </p>
          <form id="login-form">
            <div class="mb-4">
              <label
                for="user-name"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Họ và Tên</label
              >
              <input
                type="text"
                id="user-name"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                required
              />
            </div>
            <div class="mb-6">
              <label
                for="user-class"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Lớp</label
              >
              <input
                type="text"
                id="user-class"
                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                required
              />
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition duration-300"
            >
              Lưu Thông Tin
            </button>
          </form>
        </div>
      </div>

      <!-- View: Trang Chủ (Danh sách tài liệu) -->
      <!-- THAY ĐỔI: Sẽ active mặc định -->
      <div id="home-view" class="view active">
        <!-- ĐÃ SỬA: Thêm nút In Nhanh -->
        <div
          class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"
        >
          <input
            type="text"
            id="search-bar"
            class="w-full p-3 border border-gray-300 rounded-lg"
            placeholder="Tìm kiếm tài liệu..."
          />
          <div class="flex-shrink-0 w-full sm:w-auto flex gap-2">
            <button
              id="quick-print-toggle"
              class="flex-1 sm:w-auto text-center font-semibold text-white bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg"
            >
              Bật In Nhanh
            </button>
            <button
              id="quick-print-cart-btn"
              class="hidden flex-1 sm:w-auto text-center font-semibold text-white bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg"
            >
              Giỏ In (0)
            </button>
          </div>
        </div>
        <div id="folder-breadcrumbs" class="mt-2 text-sm text-gray-600"></div>
        <div
          id="document-grid"
          class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
        >
          <!-- Các thẻ tài liệu sẽ được render vào đây -->
        </div>
      </div>

      <!-- View: Đặt In (Cho tài liệu có sẵn) -->
      <div id="order-view" class="view">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
          <h2 class="text-3xl font-bold mb-4" id="order-doc-name">
            Tên Tài Liệu
          </h2>
          <p class="text-lg text-gray-600 mb-2">
            Số trang: <span id="order-doc-pages" class="font-medium">0</span>
          </p>

          <!-- ĐÃ THÊM: Nút Xem Trước File -->
          <a
            id="order-preview-btn"
            href="#"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-block bg-green-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-600 transition duration-300 mb-6"
          >
            Xem Trước File
          </a>

          <form id="order-form">
            <input type="hidden" id="order-doc-id" />
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Số bản in -->
              <div>
                <label
                  for="copies"
                  class="block text-sm font-medium text-gray-700"
                  >Số bản in</label
                >
                <input
                  type="number"
                  id="copies"
                  value="1"
                  min="1"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <!-- Size giấy -->
              <div>
                <label
                  for="paper-size"
                  class="block text-sm font-medium text-gray-700"
                  >Size giấy</label
                >
                <select
                  id="paper-size"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="A4">A4</option>
                  <option value="A5">A5</option>
                  <option value="A6">A6</option>
                </select>
              </div>
              <!-- Loại in -->
              <div>
                <label
                  for="print-type"
                  class="block text-sm font-medium text-gray-700"
                  >Loại in</label
                >
                <select
                  id="print-type"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="Thường">In thường (350đ/tờ)</option>
                  <option value="Màu">In màu (3000đ/tờ)</option>
                </select>
              </div>
              <!-- Loại giấy -->
              <div>
                <label
                  for="paper-type"
                  class="block text-sm font-medium text-gray-700"
                  >Loại giấy</label
                >
                <select
                  id="paper-type"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="A4">Giấy A4 thường</option>
                  <option value="Giấy bóng">Giấy bóng (+1000đ/tờ)</option>
                </select>
              </div>
            </div>

            <!-- Ghi chú -->
            <div class="mt-6">
              <label
                for="order-note"
                class="block text-sm font-medium text-gray-700"
                >Ghi chú (tùy chọn)</label
              >
              <textarea
                id="order-note"
                rows="3"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Ví dụ: Chỉ in trang 1, 3, 5. Đóng gáy xoắn..."
              ></textarea>
            </div>

            <!-- Tổng tiền -->
            <div class="mt-8 text-right">
              <h3 class="text-2xl font-bold">
                Tổng cộng:
                <span id="total-cost" class="text-blue-600">0</span> VND
              </h3>
            </div>

            <!-- Nút đặt hàng -->
            <div class="mt-6">
              <button
                type="submit"
                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-300"
              >
                Xác Nhận Đặt In
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- View: In Tùy Chọn (User tự tải file) - Đổi tên thành Tải File In -->
      <div id="custom-order-view" class="view">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
          <h2 class="text-3xl font-bold mb-6">Tải File Lên & In</h2>

          <!-- Khu vực tải file -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Tải file của bạn</label
            >
            <button
              id="custom-upload-widget"
              class="w-full bg-green-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-600 transition duration-300"
            >
              Chọn file để tải lên...
            </button>
            <p class="text-xs text-gray-500 mt-2">
              Hỗ trợ PDF (tự đếm trang), DOCX, PPTX, Ảnh... (Cần nhập số trang
              thủ công).
            </p>
          </div>

          <!-- Danh sách file đã tải -->
          <div id="custom-file-list" class="mb-6 space-y-3">
            <!-- File tải lên sẽ hiện ở đây -->
          </div>

          <!-- Form tùy chọn in -->
          <form id="custom-order-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Số bản in -->
              <div>
                <label
                  for="custom-copies"
                  class="block text-sm font-medium text-gray-700"
                  >Số bản in (cho mỗi file)</label
                >
                <input
                  type="number"
                  id="custom-copies"
                  value="1"
                  min="1"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <!-- Size giấy -->
              <div>
                <label
                  for="custom-paper-size"
                  class="block text-sm font-medium text-gray-700"
                  >Size giấy</label
                >
                <select
                  id="custom-paper-size"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="A4">A4</option>
                  <option value="A5">A5</option>
                  <option value="A6">A6</option>
                </select>
              </div>
              <!-- Loại in -->
              <div>
                <label
                  for="custom-print-type"
                  class="block text-sm font-medium text-gray-700"
                  >Loại in</label
                >
                <select
                  id="custom-print-type"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="Thường">In thường (350đ/tờ)</option>
                  <option value="Màu">In màu (3000đ/tờ)</option>
                </select>
              </div>
              <!-- Loại giấy -->
              <div>
                <label
                  for="custom-paper-type"
                  class="block text-sm font-medium text-gray-700"
                  >Loại giấy</label
                >
                <select
                  id="custom-paper-type"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="A4">Giấy A4 thường</option>
                  <option value="Giấy bóng">Giấy bóng (+1000đ/tờ)</option>
                </select>
              </div>
            </div>

            <!-- Ghi chú -->
            <div class="mt-6">
              <label
                for="custom-order-note"
                class="block text-sm font-medium text-gray-700"
                >Ghi chú (tùy chọn)</label
              >
              <textarea
                id="custom-order-note"
                rows="3"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Ví dụ: Chỉ in trang 1, 3, 5. Đóng gáy xoắn..."
              ></textarea>
            </div>

            <!-- Tổng tiền -->
            <div class="mt-8 text-right">
              <h3 class="text-2xl font-bold">
                Tổng cộng:
                <span id="custom-total-cost" class="text-blue-600">0</span> VND
              </h3>
            </div>

            <!-- Nút đặt hàng -->
            <div class="mt-6">
              <button
                type="submit"
                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-300"
                disabled
              >
                Xác Nhận Đặt In (Tải file trước)
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- THÊM: View In Nhanh -->
      <div id="quick-print-view" class="view">
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow-lg">
          <h2 class="text-3xl font-bold mb-6">In Nhanh (Giỏ Hàng)</h2>

          <!-- Danh sách file đã chọn -->
          <div id="quick-print-list" class="mb-6 space-y-3">
            <!-- Các file trong giỏ hàng sẽ render ở đây -->
          </div>

          <!-- Form tùy chọn in -->
          <form id="quick-print-form">
            <h3 class="text-xl font-semibold mb-4">Tùy chọn chung</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Số bản in -->
              <div>
                <label
                  for="quick-print-copies"
                  class="block text-sm font-medium text-gray-700"
                  >Số bản in (cho mỗi file)</label
                >
                <input
                  type="number"
                  id="quick-print-copies"
                  value="1"
                  min="1"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                />
              </div>
              <!-- Size giấy -->
              <div>
                <label
                  for="quick-print-paper-size"
                  class="block text-sm font-medium text-gray-700"
                  >Size giấy</label
                >
                <select
                  id="quick-print-paper-size"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="A4">A4</option>
                  <option value="A5">A5</option>
                  <option value="A6">A6</option>
                </select>
              </div>
              <!-- Loại in -->
              <div>
                <label
                  for="quick-print-print-type"
                  class="block text-sm font-medium text-gray-700"
                  >Loại in</label
                >
                <select
                  id="quick-print-print-type"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="Thường">In thường (350đ/tờ)</option>
                  <option value="Màu">In màu (3000đ/tờ)</option>
                </select>
              </div>
              <!-- Loại giấy -->
              <div>
                <label
                  for="quick-print-paper-type"
                  class="block text-sm font-medium text-gray-700"
                  >Loại giấy</label
                >
                <select
                  id="quick-print-paper-type"
                  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="A4">Giấy A4 thường</option>
                  <option value="Giấy bóng">Giấy bóng (+1000đ/tờ)</option>
                </select>
              </div>
            </div>

            <!-- Ghi chú -->
            <div class="mt-6">
              <label
                for="quick-print-note"
                class="block text-sm font-medium text-gray-700"
                >Ghi chú (tùy chọn)</label
              >
              <textarea
                id="quick-print-note"
                rows="3"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                placeholder="Ví dụ: Đóng gáy xoắn cho tất cả..."
              ></textarea>
            </div>

            <!-- Tổng tiền -->
            <div class="mt-8 text-right">
              <h3 class="text-2xl font-bold">
                Tổng cộng:
                <span id="quick-print-total-cost" class="text-blue-600">0</span>
                VND
              </h3>
            </div>

            <!-- Nút đặt hàng -->
            <div class="mt-6">
              <button
                type="submit"
                class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg hover:bg-blue-700 transition duration-300"
              >
                Xác Nhận Đặt In (Tất cả)
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- View: Lịch Sử Đơn Hàng -->
      <div id="history-view" class="view">
        <h2 class="text-3xl font-bold mb-6">Lịch Sử Đơn Hàng</h2>

        <!-- THÊM: Thống kê tổng tiền -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">Tổng Tiền Đã Chi</h3>
            <p
              id="history-total-spent"
              class="mt-1 text-2xl font-semibold text-green-600"
            >
              0đ
            </p>
          </div>
          <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="text-sm font-medium text-gray-500">
              Tổng Tiền Còn Thiếu
            </h3>
            <p
              id="history-total-due"
              class="mt-1 text-2xl font-semibold text-red-600"
            >
              0đ
            </p>
          </div>
        </div>

        <!-- Tab Lịch Sử -->
        <div class="mb-6 border-b border-gray-200">
          <nav
            class="-mb-px flex space-x-8 overflow-x-auto"
            aria-label="Tabs"
            id="history-tabs-nav"
          >
            <button
              class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600"
              data-tab="all"
            >
              Tất Cả
            </button>
            <button
              class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="pending"
            >
              Chờ thanh toán
            </button>
            <button
              class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="processing"
            >
              Đang xử lý
            </button>
            <button
              class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="completed"
            >
              Đã hoàn thành
            </button>
            <button
              class="history-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="replaced"
            >
              Đã hủy/thay thế
            </button>
          </nav>
        </div>
        <!-- KẾT THÚC: Tab Lịch Sử -->

        <!-- Bảng Lịch Sử -->
        <div class="bg-white shadow-lg rounded-lg overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Ngày Đặt
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Chi Tiết
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Tổng Tiền
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Trạng Thái
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Xem
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Sửa
                </th>
                <th
                  scope="col"
                  class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Hủy
                </th>
              </tr>
            </thead>
            <tbody
              id="history-table-body"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Dữ liệu lịch sử sẽ được render vào đây -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- View: Admin -->
      <div id="admin-view" class="view">
        <h2 class="text-3xl font-bold mb-6">Trang Quản Trị</h2>

        <!-- Admin Tabs (đã có space-x-8, nên thêm overflow-x-auto) -->
        <div class="mb-6 border-b border-gray-200">
          <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
            <button
              class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-blue-500 text-blue-600"
              data-tab="admin-docs"
            >
              Quản Lý Tài Liệu
            </button>
            <button
              class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="admin-orders"
            >
              Đơn Hàng Hiện Tại
            </button>
            <!-- THÊM: Tab Quản Lý User -->
            <button
              class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="admin-users"
            >
              Quản Lý User
            </button>
            <button
              class="admin-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"
              data-tab="admin-reports"
            >
              Báo Cáo Doanh Thu
            </button>
          </nav>
        </div>

        <!-- Admin Tab Content: Quản Lý Tài Liệu -->
        <div id="admin-docs" class="admin-tab-content">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Form thêm/sửa tài liệu -->
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="text-xl font-semibold mb-4" id="admin-form-title">
                Thêm Tài Liệu Mới
              </h3>
              <form id="admin-doc-form">
                <input type="hidden" id="admin-doc-id" />
                <div class="mb-4">
                  <label
                    for="admin-doc-name"
                    class="block text-sm font-medium text-gray-700"
                    >Tên tài liệu</label
                  >
                  <input
                    type="text"
                    id="admin-doc-name"
                    class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"
                    required
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="admin-doc-folder"
                    class="block text-sm font-medium text-gray-700"
                    >Đường dẫn thư mục (ví dụ: Lop11/GK1/Hoa)</label
                  >
                  <input
                    type="text"
                    id="admin-doc-folder"
                    class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"
                    placeholder="Lop11/GK1/Hoa"
                  />
                </div>
                <div class="mb-4">
                  <label
                    for="admin-doc-pages"
                    class="block text-sm font-medium text-gray-700"
                    >Số trang (Tự động nếu là PDF)</label
                  >
                  <input
                    type="number"
                    id="admin-doc-pages"
                    class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md transition-colors"
                    required
                    min="1"
                    placeholder="Tự động điền khi tải PDF..."
                  />
                </div>
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700"
                    >File tài liệu</label
                  >
                  <button
                    type="button"
                    id="admin-upload-widget"
                    class="mt-1 w-full bg-green-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-600"
                  >
                    Tải File 
                  </button>
                  <span
                    id="admin-file-url"
                    class="text-xs text-gray-500 block mt-1"
                  ></span>
                  <input type="hidden" id="admin-doc-url" />
                  <input type="hidden" id="admin-doc-public-id" />
                </div>
                <div class="flex space-x-2">
                  <button
                    type="submit"
                    class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700"
                  >
                    Lưu Tài Liệu
                  </button>
                  <button
                    type="button"
                    id="admin-cancel-edit"
                    class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md font-semibold hover:bg-gray-400 hidden"
                  >
                    Hủy
                  </button>
                </div>
              </form>
            </div>
            <!-- Danh sách tài liệu -->
            <div class="bg-white p-6 rounded-lg shadow">
              <div class="mb-4">
                <input
                  type="text"
                  id="admin-search-bar"
                  class="w-full p-3 border border-gray-300 rounded-lg"
                  placeholder="Tìm kiếm trong danh sách tài liệu..."
                />
              </div>

              <h3 class="text-xl font-semibold mb-4">Danh Sách Tài Liệu</h3>
              <div
                id="admin-doc-list"
                class="space-y-3 max-h-96 overflow-y-auto"
              >
                <!-- Dữ liệu render ở đây -->
              </div>
            </div>
          </div>
        </div>

        <!-- Admin Tab Content: Đơn Hàng Hiện Tại -->
        <div id="admin-orders" class="admin-tab-content hidden">
          <div class="bg-white shadow-lg rounded-lg overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Ngày
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Người Đặt
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Chi Tiết
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Tổng Tiền
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Trạng Thái
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Xem
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Sửa
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    HĐ Thanh Toán
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    HĐ In
                  </th>
                </tr>
              </thead>
              <tbody
                id="admin-orders-table-body"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Dữ liệu render ở đây -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- THÊM: Admin Tab Content: Quản Lý User -->
        <div id="admin-users" class="admin-tab-content hidden">
          <div class="bg-white shadow-lg rounded-lg overflow-x-auto">
            <table
              class="min-w-full divide-y divide-gray-200"
              id="admin-users-table"
            >
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Họ Tên
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Lớp
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Số Dư
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Tổng Đã Chi
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    Tổng Còn Thiếu
                  </th>
                </tr>
              </thead>
              <tbody
                id="admin-users-table-body"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Dữ liệu user sẽ render ở đây -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Admin Tab Content: Báo Cáo Doanh Thu -->
        <div id="admin-reports" class="admin-tab-content hidden">
          <div class="bg-white p-6 rounded-lg shadow">
            <div
              class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3"
            >
              <h3 class="text-xl font-semibold">Báo Cáo Doanh Thu</h3>
              <div
                class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto"
              >
                <select
                  id="report-month"
                  class="border border-gray-300 rounded-md"
                >
                  <!-- Các tháng sẽ được render ở đây -->
                </select>
                <button
                  id="export-excel-btn"
                  class="bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700"
                >
                  Xuất Excel
                </button>
              </div>
            </div>

            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
              <h4 class="text-lg font-bold text-blue-800">
                Tổng Doanh Thu (Tháng <span id="report-month-display"></span>):
                <span id="report-total-revenue" class="text-2xl">0</span> VND
              </h4>
            </div>

            <h4 class="text-lg font-semibold mb-2">
              Các Đơn Đã Thanh Toán (trong tháng)
            </h4>
            <div
              class="max-h-64 overflow-y-auto overflow-x-auto mb-6 border rounded-lg"
            >
              <table
                class="min-w-full divide-y divide-gray-200"
                id="report-paid-table"
              >
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th
                      class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Ngày
                    </th>
                    <th
                      class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Người Đặt
                    </th>
                    <th
                      class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Số Tiền
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="report-paid-body"
                  class="bg-white divide-y divide-gray-200"
                ></tbody>
              </table>
            </div>

            <h4 class="text-lg font-semibold mb-2 text-red-600">
              Các Đơn Chưa Thanh Toán (tất cả)
            </h4>
            <div
              class="max-h-64 overflow-y-auto overflow-x-auto border rounded-lg"
            >
              <table
                class="min-w-full divide-y divide-gray-200"
                id="report-unpaid-table"
              >
                <thead class="bg-gray-50 sticky top-0">
                  <tr>
                    <th
                      class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Ngày
                    </th>
                    <th
                      class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Người Đặt
                    </th>
                    <th
                      class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase"
                    >
                      Số Tiền
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="report-unpaid-body"
                  class="bg-white divide-y divide-gray-200"
                ></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal Thông Báo -->
    <div
      id="message-modal"
      class="view fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[10000]"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white mx-4 sm:mx-auto"
      >
        <div class="mt-3 text-center">
          <h3
            class="text-lg leading-6 font-medium text-gray-900"
            id="message-modal-title"
          >
            Thông báo
          </h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500" id="message-modal-content"></p>
          </div>
          <div class="items-center px-4 py-3">
            <button
              id="message-modal-close"
              class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300"
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Chi Tiết Đơn Hàng -->
    <div
      id="order-details-modal"
      class="view fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[10000]"
    >
      <div
        class="relative top-10 mx-auto p-6 border w-full max-w-lg shadow-lg rounded-md bg-white m-4"
      >
        <div class="mt-3">
          <h3
            class="text-xl leading-6 font-bold text-gray-900"
            id="order-details-modal-title"
          >
            Chi Tiết Đơn Hàng
          </h3>
          <div
            id="order-details-modal-content"
            class="mt-4 space-y-4 text-sm text-gray-700 max-h-[70vh] overflow-y-auto"
          >
            <!-- Chi tiết sẽ được render vào đây -->
          </div>
          <div class="items-center px-4 py-3 mt-4 text-right">
            <button
              id="order-details-modal-close"
              class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300"
            >
              Đóng
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Chỉnh Sửa Đơn Hàng -->
    <div
      id="edit-order-modal"
      class="view fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[10000]"
    >
      <div
        class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-lg rounded-md bg-white m-4"
      >
        <h3 class="text-2xl leading-6 font-bold text-gray-900 mb-6">
          Chỉnh Sửa Đơn Hàng
        </h3>

        <!-- Form chỉnh sửa -->
        <form id="edit-order-form" class="max-h-[80vh] overflow-y-auto pr-2">
          <!-- Thông tin ẩn -->
          <input type="hidden" id="edit-order-id" />
          <input type="hidden" id="edit-order-original-cost" />
          <input type="hidden" id="edit-order-user-id" />
          <input type="hidden" id="edit-order-original-payment-status" />
          <input type="hidden" id="edit-order-original-amount-paid" />

          <!-- Khu vực file -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Các file trong đơn hàng</label
            >
            <!-- Danh sách file -->
            <div id="edit-file-list" class="mb-3 space-y-3">
              <!-- File sẽ render ở đây -->
            </div>
            <button
              type="button"
              id="edit-upload-widget"
              class="w-full bg-green-500 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-600 transition duration-300"
            >
              Thêm file mới...
            </button>
          </div>

          <!-- Tùy chọn in -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Số bản in -->
            <div>
              <label
                for="edit-copies"
                class="block text-sm font-medium text-gray-700"
                >Số bản in (cho mỗi file)</label
              >
              <input
                type="number"
                id="edit-copies"
                value="1"
                min="1"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
            <!-- Size giấy -->
            <div>
              <label
                for="edit-paper-size"
                class="block text-sm font-medium text-gray-700"
                >Size giấy</label
              >
              <select
                id="edit-paper-size"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="A4">A4</option>
                <option value="A5">A5</option>
                <option value="A6">A6</option>
              </select>
            </div>
            <!-- Loại in -->
            <div>
              <label
                for="edit-print-type"
                class="block text-sm font-medium text-gray-700"
                >Loại in</label
              >
              <select
                id="edit-print-type"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="Thường">In thường (350đ/tờ)</option>
                <option value="Màu">In màu (3000đ/tờ)</option>
              </select>
            </div>
            <!-- Loại giấy -->
            <div>
              <label
                for="edit-paper-type"
                class="block text-sm font-medium text-gray-700"
                >Loại giấy</label
              >
              <select
                id="edit-paper-type"
                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="A4">Giấy A4 thường</option>
                <option value="Giấy bóng">Giấy bóng (+1000đ/tờ)</option>
              </select>
            </div>
          </div>

          <!-- Ghi chú -->
          <div class="mt-6">
            <label
              for="edit-order-note"
              class="block text-sm font-medium text-gray-700"
              >Ghi chú (tùy chọn)</label
            >
            <textarea
              id="edit-order-note"
              rows="3"
              class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            ></textarea>
          </div>

          <!-- Tổng tiền -->
          <div class="mt-8 text-right">
            <h3 class="text-2xl font-bold">
              Tổng cộng (mới):
              <span id="edit-total-cost" class="text-blue-600">0</span> VND
            </h3>
            <p class="text-sm text-gray-500">
              Đơn hàng cũ sẽ bị hủy và hoàn tiền (nếu đã trả).<br />
              Đơn hàng mới sẽ được tạo và thanh toán bằng số dư.
            </p>
          </div>

          <!-- Nút hành động -->
          <div class="items-center mt-6 flex space-x-4">
            <button
              id="edit-order-modal-close"
              type="button"
              class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none"
            >
              Hủy
            </button>
            <button
              id="edit-order-modal-save"
              type="submit"
              class="flex-1 px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none"
            >
              Lưu Thay Đổi
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import các hàm Firebase cần thiết
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        onValue,
        push,
        update,
        remove,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

      // --- CẤU HÌNH CẦN THAY ĐỔI ---
      const CLOUDINARY_CLOUD_NAME = "dys3wgutz"; // <-- THAY TÊN CLOUD CỦA BẠN VÀO ĐÂY
      const CLOUDINARY_UPLOAD_PRESET = "comic_raw_files_preset"; // <-- THAY UPLOAD PRESET CỦA BẠN VÀO ĐÂY
      const DISCORD_WEBHOOK_URL =
        "https://discord.com/api/webhooks/1434159428902457427/Hdym5vRapor2JsACAR48gkSatGhGAygtLmRiyDfKxiGXgP2YThucCxtLGllaPp83pDuw"; // <-- THAY URL WEBHOOK DISCORD CỦA BẠN VÀO ĐÂY
      // ------------------------------

      // Cấu hình Firebase (Lấy từ biến global do Canvas cung cấp)
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : {
              // Cấu hình dự phòng nếu không chạy trên Canvas
              apiKey: "AIzaSyClgpNsnykC6NHj0TQI_b4SnuHGinfcmSo",
              authDomain: "print-8a369.firebaseapp.com",
              databaseURL: "https://print-8a369-default-rtdb.firebaseio.com",
              projectId: "print-8a369",
              storageBucket: "print-8a369.firebasestorage.app",
              messagingSenderId: "401581755279",
              appId: "1:401581755279:web:3511a55eb4ee5acb0a99fa",
              measurementId: "G-3S19TQHPHX",
            };

      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-print-app-id";

      // Khởi tạo Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      // Biến toàn cục
      let currentUser = null;
      let currentUserId = null;
      let currentUserData = null;
      let allDocuments = {}; // Cache lại danh sách tài liệu
      let allOrders = {}; // Cache lại danh sách đơn hàng
      let allUsersData = {}; // THÊM: Cache lại danh sách user
      let customUploadedFiles = []; // Mảng lưu file user tự upload

      // THÊM: Biến cho In Nhanh
      let isQuickPrintMode = false;
      let quickPrintCart = []; // Mảng lưu các docId

      // THÊM: Biến cho modal chỉnh sửa
      let filesBeingEdited = []; // Mảng lưu file đang được sửa
      let editUploadWidget = null; // Widget Cloudinary cho modal edit

      // DOM Elements
      const loadingOverlay = document.getElementById("loading-overlay");
      const appElement = document.getElementById("app");
      const loginView = document.getElementById("login-view");
      const allViews = document.querySelectorAll(".view");
      const allNavLinks = document.querySelectorAll(".nav-link");
      const allAdminTabs = document.querySelectorAll(".admin-tab");
      const allAdminTabContents =
        document.querySelectorAll(".admin-tab-content");
      const orderDetailsModal = document.getElementById("order-details-modal");
      const orderDetailsModalContent = document.getElementById(
        "order-details-modal-content"
      );
      const editOrderModal = document.getElementById("edit-order-modal");
      const editOrderForm = document.getElementById("edit-order-form");
      const editFileList = document.getElementById("edit-file-list");

      // THÊM: DOM Elements cho Menu Mobile
      const menuToggle = document.getElementById("menu-toggle");
      const menuClose = document.getElementById("menu-close");
      const mobileMenu = document.getElementById("mobile-menu");
      const menuOverlay = document.getElementById("menu-overlay");

      // --- HÀM TIỆN ÍCH ---

      function showLoading(show) {
        loadingOverlay.style.display = show ? "flex" : "none";
      }

      function showMessage(title, content) {
        document.getElementById("message-modal-title").textContent = title;
        document.getElementById("message-modal-content").textContent = content;
        document.getElementById("message-modal").style.display = "block";
      }

      document
        .getElementById("message-modal-close")
        .addEventListener("click", () => {
          document.getElementById("message-modal").style.display = "none";
        });

      // THÊM: Hàm kiểm tra đăng nhập trước khi hành động
      function checkAuthAndShowLogin() {
        if (currentUserData && currentUserData.isGuest) {
          showMessage(
            "Yêu Cầu Đăng Nhập",
            "Bạn cần đăng nhập để thực hiện chức năng này. Vui lòng cập nhật thông tin Họ Tên và Lớp."
          );
          showView("login-view");
          return false;
        }
        return true;
      }

      // Hàm copy link chia sẻ
      function copyShareLink(docId) {
        const url = window.location.href.split("#")[0];
        const shareLink = url + "#doc=" + docId;
        const textarea = document.createElement("textarea");
        textarea.value = shareLink;
        textarea.style.position = "fixed";
        textarea.style.top = 0;
        textarea.style.left = 0;
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        try {
          const successful = document.execCommand("copy");
          if (successful) {
            showMessage("Đã Sao Chép", "Đã copy link chia sẻ vào clipboard.");
          } else {
            showMessage("Lỗi", "Không thể copy link. Vui lòng thử lại.");
          }
        } catch (err) {
          console.error("Lỗi copy clipboard:", err);
          showMessage("Lỗi", "Không thể copy link.");
        }
        document.body.removeChild(textarea);
      }

      // Hàm trợ giúp xử lý link PDF (tải về)
      function getForcedDownloadLink(url, name = "") {
        if (!url) return "#";
        const fileName = name.toLowerCase();
        const fileUrl = url.toLowerCase();
        const isPdf = fileUrl.endsWith(".pdf") || fileName.endsWith(".pdf");

        if (isPdf && url.includes("res.cloudinary.com")) {
          const parts = url.split("/upload/");
          if (parts.length === 2 && !parts[1].startsWith("fl_attachment")) {
            return parts[0] + "/upload/fl_attachment/" + parts[1];
          }
        }
        return url;
      }

      // Hàm thêm thuộc tính download
      function getDownloadAttribute(url, name = "") {
        if (!url) return "";
        const fileName = name.toLowerCase();
        const fileUrl = url.toLowerCase();
        const isPdf = fileUrl.endsWith(".pdf") || fileName.endsWith(".pdf");

        if (isPdf && !url.includes("res.cloudinary.com")) {
          return "download";
        }
        return "";
      }

      // --- HÀM MODAL CHI TIẾT ĐƠN HÀNG ---
      document
        .getElementById("order-details-modal-close")
        .addEventListener("click", () => {
          orderDetailsModal.style.display = "none";
        });

      function showOrderDetailsModal(order) {
        const itemsHtml = order.items
          .map((item) => {
            let url = "#";
            let name = item.docName;
            if (item.cloudinaryUrl) {
              url = item.cloudinaryUrl;
            } else if (item.docId && allDocuments[item.docId]) {
              url = allDocuments[item.docId].url;
            }
            const fileUrl = getForcedDownloadLink(url, name);
            const downloadAttr = getDownloadAttribute(url, name);
            return `
                      <div class="p-3 bg-gray-50 rounded-md border">
                          <p class="font-semibold text-gray-800">Tên file: <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline">${item.docName}</a></p>
                          <p>Số trang: ${item.pages} | Số bản: ${item.copies}</p>
                          <p>Tùy chọn: ${item.printType}, ${item.paperType}, ${item.paperSize}</p>
                      </div>
                  `;
          })
          .join("");

        let paymentStatusHtml = "";
        if (order.paymentStatus === "paid") {
          paymentStatusHtml = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Đã thanh toán</span>`;
        } else if (order.paymentStatus === "pending") {
          paymentStatusHtml = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Chờ thanh toán (Còn ${formatCurrency(
            order.amountDue || 0
          )}đ)</span>`;
        } else if (order.paymentStatus === "replaced") {
          paymentStatusHtml = `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Đã thay thế</span>`;
        }

        const printStatusHtml = order.isPrinted
          ? `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Đã In</span>`
          : `<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Chưa In</span>`;

        const contentHtml = `
                  <div class="space-y-3">
                      <p><strong>Người đặt:</strong> ${order.userName} (${
          order.userClass
        })</p>
                      <p><strong>Ngày đặt:</strong> ${formatDate(
                        order.timestamp
                      )}</p>
                      <p><strong>Tổng tiền:</strong> <span class="font-bold text-lg text-blue-700">${formatCurrency(
                        order.totalCost
                      )}đ</span></p>
                      <p><strong>Trạng thái:</strong> ${paymentStatusHtml} ${printStatusHtml}</p>
                      ${
                        order.ghiChu
                          ? `<div class="p-3 bg-red-50 border border-red-200 rounded-md">
                               <p class="font-semibold text-red-800">Ghi chú của khách:</p>
                               <p class="text-red-700 whitespace-pre-wrap">${order.ghiChu}</p>
                             </div>`
                          : "<p>Không có ghi chú.</p>"
                      }
                      <hr>
                      <p class="font-bold"><strong>Các mục đã đặt:</strong></p>
                      <div class="space-y-2">${itemsHtml}</div>
                  </div>
              `;

        orderDetailsModalContent.innerHTML = contentHtml;
        orderDetailsModal.style.display = "block";
      }

      // --- HÀM ĐIỀU HƯỚNG & MENU ---

      // Hàm chuyển đổi view
      function showView(viewId) {
        // THÊM: Kiểm tra đăng nhập cho các view cần thiết
        if (["history-view", "admin-view"].includes(viewId)) {
          if (!checkAuthAndShowLogin()) return;
        }

        allViews.forEach((view) => view.classList.remove("active"));
        document.getElementById(viewId)?.classList.add("active");

        // Cập nhật trạng thái active cho nav links
        allNavLinks.forEach((link) => {
          link.classList.remove("text-blue-600", "font-bold");
          link.classList.add("text-gray-700", "font-medium");
          if (link.dataset.view === viewId) {
            link.classList.add("text-blue-600", "font-bold");
            link.classList.remove("text-gray-700", "font-medium");
          }
        });

        // Đóng menu mobile khi chuyển view
        closeMobileMenu();

        // Xử lý logic riêng cho từng view
        if (viewId === "admin-view") {
          const firstTab = document.querySelector(".admin-tab");
          switchAdminTab(firstTab.dataset.tab);
        }
        if (viewId === "history-view") {
          // Đặt lại tab 'all' là active khi chuyển view
          document.querySelectorAll(".history-tab").forEach((tab, index) => {
            tab.classList.remove("border-blue-500", "text-blue-600");
            tab.classList.add(
              "border-transparent",
              "text-gray-500",
              "hover:text-gray-700",
              "hover:border-gray-300"
            );
            if (index === 0) {
              tab.classList.add("border-blue-500", "text-blue-600");
              tab.classList.remove(
                "border-transparent",
                "text-gray-500",
                "hover:text-gray-700",
                "hover:border-gray-300"
              );
            }
          });
          renderUserHistory(); // Render lại lịch sử
        }
        // THÊM: Render view In Nhanh
        if (viewId === "quick-print-view") {
          renderQuickPrintView();
        }
      }

      // Hàm chuyển đổi tab Admin
      function switchAdminTab(tabId) {
        allAdminTabContents.forEach((content) =>
          content.classList.add("hidden")
        );
        document.getElementById(tabId)?.classList.remove("hidden");

        allAdminTabs.forEach((tab) => {
          tab.classList.remove("border-blue-500", "text-blue-600");
          tab.classList.add(
            "border-transparent",
            "text-gray-500",
            "hover:text-gray-700",
            "hover:border-gray-300"
          );
          if (tab.dataset.tab === tabId) {
            tab.classList.add("border-blue-500", "text-blue-600");
            tab.classList.remove(
              "border-transparent",
              "text-gray-500",
              "hover:text-gray-700",
              "hover:border-gray-300"
            );
          }
        });
      }

      // THÊM: Hàm cho Menu Mobile
      function openMobileMenu() {
        mobileMenu.classList.remove("closed");
        mobileMenu.classList.add("open");
        menuOverlay.classList.remove("hidden");
      }

      function closeMobileMenu() {
        mobileMenu.classList.remove("open");
        mobileMenu.classList.add("closed");
        menuOverlay.classList.add("hidden");
      }

      menuToggle.addEventListener("click", openMobileMenu);
      menuClose.addEventListener("click", closeMobileMenu);
      menuOverlay.addEventListener("click", closeMobileMenu);

      // --- HÀM ĐỊNH DẠNG ---

      // Hàm định dạng tiền tệ
      function formatCurrency(value) {
        return new Intl.NumberFormat("vi-VN").format(value);
      }

      // Hàm định dạng ngày
      function formatDate(timestamp) {
        return new Date(timestamp).toLocaleString("vi-VN");
      }

      // Hàm tính toán chi phí (đã sửa theo logic 2 trang = 1 tờ)
      function calculateCost(pages, copies, printType, paperType) {
        const sheets = Math.ceil(parseInt(pages) / 2); // Làm tròn lên
        const baseCost = printType === "Màu" ? 3000 : 350;
        const glossyBonus = paperType === "Giấy bóng" ? 1000 : 0;
        const total = (baseCost + glossyBonus) * sheets * parseInt(copies);
        return total;
      }

      // --- HÀM XÁC THỰC & KHỞI TẠO ---

      // THAY ĐỔI: Logic khởi tạo
      async function initializeAppLogic() {
        if (window.location.hash.startsWith("#doc=")) {
          const initialDocId = window.location.hash.substring(5);
          sessionStorage.setItem("deepLinkDocId", initialDocId);
          try {
            history.replaceState(
              null,
              null,
              window.location.pathname + window.location.search
            );
          } catch (e) {
            window.location.hash = "";
          }
        }

        showLoading(true);
        try {
          const userCredential =
            typeof __initial_auth_token !== "undefined"
              ? await signInWithCustomToken(auth, __initial_auth_token)
              : await signInAnonymously(auth);

          currentUser = userCredential.user;
          currentUserId = currentUser.uid;

          const userRef = ref(db, `artifacts/${appId}/users/${currentUserId}`);
          const snapshot = await get(userRef);

          if (snapshot.exists()) {
            currentUserData = snapshot.val();
            currentUserData.isGuest = false; // Người dùng đã đăng ký
          } else {
            // Người dùng mới, tạo tài khoản Khách
            currentUserData = {
              name: "Khách",
              class: "Vãng lai",
              balance: 0,
              isGuest: true, // Đánh dấu là khách
            };
            // Không show login-view
          }

          updateUserInfoUI();
          showView("home-view"); // Luôn bắt đầu ở trang chủ
          setupListeners();
        } catch (error) {
          console.error("Lỗi khởi tạo:", error);
          showMessage(
            "Lỗi",
            "Không thể khởi tạo ứng dụng. Vui lòng tải lại trang."
          );
        } finally {
          showLoading(false);
        }
      }

      // Xử lý form đăng nhập
      document
        .getElementById("login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const name = document.getElementById("user-name").value.trim();
          const lop = document.getElementById("user-class").value.trim();

          if (!name || !lop) {
            showMessage("Lỗi", "Vui lòng nhập đầy đủ Họ Tên và Lớp.");
            return;
          }

          showLoading(true);
          try {
            currentUserData = {
              name: name,
              class: lop,
              balance: 0,
              isGuest: false, // ĐÃ THAY ĐỔI: không còn là khách
            };
            const userRef = ref(
              db,
              `artifacts/${appId}/users/${currentUserId}`
            );
            await set(userRef, currentUserData);

            updateUserInfoUI();
            showView("home-view"); // Quay lại trang chủ
            // setupListeners() đã được gọi trong initializeAppLogic,
            // nhưng gọi lại ở đây để đảm bảo listener onValue(userRef) được kích hoạt ngay
            setupListeners();
          } catch (error) {
            console.error("Lỗi lưu thông tin:", error);
            showMessage("Lỗi", "Không thể lưu thông tin. Vui lòng thử lại.");
          } finally {
            showLoading(false);
          }
        });

      // Cập nhật UI thông tin user (cho cả desktop và mobile)
      // THAY ĐỔI: Logic hiển thị dựa trên isGuest
      function updateUserInfoUI() {
        if (!currentUserData) return;

        const loginNavLink = document.getElementById("login-nav-link");
        const loginNavLinkMobile = document.getElementById(
          "login-nav-link-mobile"
        );
        const userInfoDesktop = document.getElementById("user-info-desktop");
        const userInfoMobile = document.getElementById("user-info-mobile");

        if (currentUserData.isGuest) {
          // Là khách
          loginNavLink.classList.remove("hidden");
          loginNavLinkMobile.classList.remove("hidden");
          userInfoDesktop.classList.add("hidden");
          userInfoMobile.classList.add("hidden");

          // Ẩn link admin (khách không thể là admin)
          document.getElementById("admin-nav-link").classList.add("hidden");
          document
            .getElementById("admin-nav-link-mobile")
            .classList.add("hidden");
        } else {
          // Đã đăng nhập
          loginNavLink.classList.add("hidden");
          loginNavLinkMobile.classList.add("hidden");
          userInfoDesktop.classList.remove("hidden");
          userInfoMobile.classList.remove("hidden");

          const name = currentUserData.name;
          const lop = `(${currentUserData.class})`;
          const balance = `${formatCurrency(currentUserData.balance || 0)}đ`;

          // Desktop
          document.getElementById("user-name-display").textContent = name;
          document.getElementById("user-class-display").textContent = lop;
          document.getElementById("user-balance-display").textContent = balance;

          // Mobile
          document.getElementById("user-name-display-mobile").textContent =
            name;
          document.getElementById("user-class-display-mobile").textContent =
            lop;
          document.getElementById("user-balance-display-mobile").textContent =
            balance;

          // Admin Links
          if (currentUserData.name === "Admin") {
            document
              .getElementById("admin-nav-link")
              .classList.remove("hidden");
            document
              .getElementById("admin-nav-link-mobile")
              .classList.remove("hidden");
          } else {
            document.getElementById("admin-nav-link").classList.add("hidden");
            document
              .getElementById("admin-nav-link-mobile")
              .classList.add("hidden");
          }
        }
      }

      // --- HÀM LẮNG NGHE DỮ LIỆU (LISTENERS) ---

      function setupListeners() {
        // Lắng nghe thay đổi thông tin user
        const userRef = ref(db, `artifacts/${appId}/users/${currentUserId}`);
        onValue(userRef, (snapshot) => {
          if (snapshot.exists()) {
            // Chỉ cập nhật nếu user không còn là khách
            // hoặc nếu dữ liệu mới tồn tại (nghĩa là họ vừa đăng ký)
            if (!currentUserData.isGuest || snapshot.exists()) {
              currentUserData = snapshot.val();
              currentUserData.isGuest = false;
              updateUserInfoUI();
            }
          } else if (currentUserData && !currentUserData.isGuest) {
            // Trường hợp hiếm: user đã đăng nhập bị xóa, coi họ như khách
            currentUserData.isGuest = true;
            updateUserInfoUI();
          }
        });

        // Lắng nghe danh sách tài liệu
        const docsRef = ref(db, `artifacts/${appId}/public/documents`);
        onValue(docsRef, (snapshot) => {
          allDocuments = snapshot.val() || {};
          renderDocumentGrid();
          if (currentUserData && currentUserData.name === "Admin") {
            renderAdminDocList();
          }

          const pendingDocId = sessionStorage.getItem("deepLinkDocId");
          if (pendingDocId && allDocuments[pendingDocId]) {
            // Không cần check currentUserData nữa vì khách cũng xem được
            openOrderView(pendingDocId);
            sessionStorage.removeItem("deepLinkDocId");
          }
        });

        // Lắng nghe danh sách đơn hàng
        const ordersRef = ref(db, `artifacts/${appId}/public/orders`);
        onValue(ordersRef, (snapshot) => {
          allOrders = snapshot.val() || {};
          renderDocumentGrid(); // Cập nhật lượt in

          // Chỉ render history/admin nếu user đã đăng nhập
          if (currentUserData && !currentUserData.isGuest) {
            renderUserHistory(); // Cập nhật lịch sử user
            if (currentUserData.name === "Admin") {
              renderAdminOrdersTable();
              renderAdminReports();
              renderAdminUsersTable(); // Cập nhật tổng tiền user
            }
          }
        });

        // THÊM: Lắng nghe danh sách user (cho Admin)
        const allUsersRef = ref(db, `artifacts/${appId}/users`);
        onValue(allUsersRef, (snapshot) => {
          allUsersData = snapshot.val() || {};
          if (currentUserData && currentUserData.name === "Admin") {
            renderAdminUsersTable();
          }
        });

        // Listeners cho tìm kiếm
        document
          .getElementById("admin-search-bar")
          .addEventListener("input", renderAdminDocList);
        document
          .getElementById("search-bar")
          .addEventListener("input", renderDocumentGrid);

        // Listener cho tab lịch sử
        document
          .getElementById("history-tabs-nav")
          .addEventListener("click", (e) => {
            const tabButton = e.target.closest(".history-tab");
            if (!tabButton) return;

            // THÊM: Check auth khi click tab
            if (!checkAuthAndShowLogin()) return;

            document.querySelectorAll(".history-tab").forEach((tab) => {
              tab.classList.remove("border-blue-500", "text-blue-600");
              tab.classList.add(
                "border-transparent",
                "text-gray-500",
                "hover:text-gray-700",
                "hover:border-gray-300"
              );
            });
            tabButton.classList.add("border-blue-500", "text-blue-600");
            tabButton.classList.remove(
              "border-transparent",
              "text-gray-500",
              "hover:text-gray-700",
              "hover:border-gray-300"
            );
            renderUserHistory();
          });

        // THÊM: Listeners cho In Nhanh
        document
          .getElementById("quick-print-toggle")
          .addEventListener("click", toggleQuickPrintMode);
        document
          .getElementById("quick-print-cart-btn")
          .addEventListener("click", () => showView("quick-print-view"));

        // Thiết lập tháng cho báo cáo
        setupReportMonths();
      }

      // --- LOGIC TRANG CHỦ (HOME) & IN NHANH ---

      // ĐÃ SỬA: Hàm render chính
      function renderDocumentGrid() {
        const grid = document.getElementById("document-grid");
        grid.innerHTML = "";

        const printCounts = {};
        Object.values(allOrders).forEach((order) => {
          if (order.paymentStatus !== "replaced") {
            order.items.forEach((item) => {
              if (item.docId) {
                printCounts[item.docId] = (printCounts[item.docId] || 0) + 1;
              }
            });
          }
        });

        const searchTerm = document
          .getElementById("search-bar")
          .value.toLowerCase();
        const filteredDocs = Object.entries(allDocuments).filter(
          ([id, doc]) => {
            const name = doc.name?.toLowerCase() || "";
            const folder = doc.folderPath?.toLowerCase() || "";
            return name.includes(searchTerm) || folder.includes(searchTerm);
          }
        );

        if (filteredDocs.length === 0) {
          grid.innerHTML =
            '<p class="col-span-full text-center text-gray-500">Không tìm thấy tài liệu nào.</p>';
          return;
        }

        filteredDocs.sort(([, a], [, b]) => {
          const folderCompare = (a.folderPath || "").localeCompare(
            b.folderPath || ""
          );
          if (folderCompare !== 0) return folderCompare;
          return (a.name || "").localeCompare(b.name || "");
        });

        let currentFolder = null;
        filteredDocs.forEach(([id, doc]) => {
          if (doc.folderPath && doc.folderPath !== currentFolder) {
            currentFolder = doc.folderPath;
            const folderHeader = document.createElement("h3");
            folderHeader.className =
              "col-span-full text-xl font-bold mt-6 mb-2 text-gray-700";
            folderHeader.textContent = currentFolder.replace(/\//g, " / ");
            grid.appendChild(folderHeader);
          }

          const printCount = printCounts[id] || 0;
          const fileUrl = getForcedDownloadLink(doc.url, doc.name);
          const downloadAttr = getDownloadAttribute(doc.url, doc.name);

          const card = document.createElement("div");
          // SỬA: Thêm `relative` cho checkbox, xóa 2 nút
          card.className =
            "bg-white rounded-lg shadow-md overflow-hidden transform transition-all hover:shadow-xl hover:-translate-y-1 relative";

          // SỬA: Bỏ 2 nút, chỉ còn P-5
          let cardHTML = `
                      <div class="p-5">
                          <div class="flex justify-between items-start">
                              <h3 class="text-lg font-semibold text-gray-800 truncate flex-1 mr-2" title="${
                                doc.name
                              }">${doc.name}</h3>
                              <button class="flex-shrink-0 text-gray-400 hover:text-blue-500 share-doc-btn" data-doc-id="${id}" title="Copy link chia sẻ">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                      <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.658 14.185 8 15 8z" />
                                  </svg>
                              </button>
                          </div>
                          <p class="text-sm text-gray-500 mt-1">${
                            doc.folderPath || "Thư mục gốc"
                          }</p>
                          <div class="flex justify-between items-center text-sm text-gray-600 mt-2 font-medium">
                            <span>${doc.pages || "?"} trang</span>
                            <span class="text-blue-500">${printCount} lượt in</span>
                          </div>
                      </div>
                  `;

          // Xử lý logic cho In Nhanh
          if (isQuickPrintMode) {
            card.classList.add("quick-print-card");
            card.dataset.docId = id;
            // Thêm checkbox
            cardHTML += `
                          <input type="checkbox" class="absolute top-3 right-3 h-6 w-6 text-blue-600 border-gray-300 rounded focus:ring-blue-500 quick-print-checkbox" data-doc-id="${id}" ${
              quickPrintCart.includes(id) ? "checked" : ""
            }>
                      `;
            // Thêm nút Xem File ở footer
            cardHTML += `
                          <div class="bg-gray-50 px-5 py-3">
                              <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="w-full text-center text-sm font-semibold text-green-600 hover:text-green-800 px-3 py-1 bg-green-50 rounded-md border border-green-200 hover:bg-green-100">Xem File</a>
                          </div>
                      `;
          } else {
            // Chế độ thường: Thẻ có thể click
            card.classList.add("select-doc-card", "cursor-pointer");
            card.dataset.docId = id;
          }

          card.innerHTML = cardHTML;

          card
            .querySelector(".share-doc-btn")
            .addEventListener("click", (e) => {
              e.stopPropagation();
              copyShareLink(id);
            });

          grid.appendChild(card);
        });
      }

      // THÊM: Listener chung cho Grid (xử lý cả 2 chế độ)
      document
        .getElementById("document-grid")
        .addEventListener("click", (e) => {
          // Ngăn click vào link "Xem File" hoặc "Share" trigger chọn thẻ
          if (e.target.closest("a") || e.target.closest(".share-doc-btn")) {
            return;
          }

          if (isQuickPrintMode) {
            const card = e.target.closest(".quick-print-card");
            if (!card) return;

            const docId = card.dataset.docId;
            const checkbox = card.querySelector(".quick-print-checkbox");
            if (docId && checkbox) {
              // Đảo ngược trạng thái
              const newCheckedState = !checkbox.checked;
              checkbox.checked = newCheckedState;
              toggleQuickPrintItem(docId, newCheckedState);
            }
          } else {
            // Chế độ thường
            const card = e.target.closest(".select-doc-card");
            if (card) {
              const docId = card.dataset.docId;
              if (docId) {
                openOrderView(docId);
              }
            }
          }
        });

      // THÊM: Xử lý click vào checkbox (để tránh trigger click vào card)
      document
        .getElementById("document-grid")
        .addEventListener("change", (e) => {
          if (
            isQuickPrintMode &&
            e.target.classList.contains("quick-print-checkbox")
          ) {
            const docId = e.target.dataset.docId;
            toggleQuickPrintItem(docId, e.target.checked);
          }
        });

      // THÊM: Hàm bật/tắt In Nhanh
      function toggleQuickPrintMode() {
        isQuickPrintMode = !isQuickPrintMode;
        const toggleBtn = document.getElementById("quick-print-toggle");
        const cartBtn = document.getElementById("quick-print-cart-btn");

        if (isQuickPrintMode) {
          toggleBtn.textContent = "Tắt In Nhanh";
          toggleBtn.classList.remove("bg-purple-600", "hover:bg-purple-700");
          toggleBtn.classList.add("bg-gray-500", "hover:bg-gray-600");
          cartBtn.classList.remove("hidden");
        } else {
          toggleBtn.textContent = "Bật In Nhanh";
          toggleBtn.classList.add("bg-purple-600", "hover:bg-purple-700");
          toggleBtn.classList.remove("bg-gray-500", "hover:bg-gray-600");
          cartBtn.classList.add("hidden");
        }
        updateQuickPrintCartCount();
        renderDocumentGrid(); // Vẽ lại grid
      }

      // THÊM: Hàm cập nhật giỏ hàng In Nhanh
      function toggleQuickPrintItem(docId, isChecked) {
        const index = quickPrintCart.indexOf(docId);
        if (isChecked && index === -1) {
          quickPrintCart.push(docId);
        } else if (!isChecked && index > -1) {
          quickPrintCart.splice(index, 1);
        }
        updateQuickPrintCartCount();
      }

      // THÊM: Hàm cập nhật số lượng trên nút giỏ hàng
      function updateQuickPrintCartCount() {
        const cartBtn = document.getElementById("quick-print-cart-btn");
        cartBtn.textContent = `Giỏ In (${quickPrintCart.length})`;
      }

      // --- LOGIC ĐẶT IN (THƯỜNG) ---

      // ĐÃ SỬA: Thêm logic cho nút Xem Trước
      function openOrderView(docId) {
        const doc = allDocuments[docId];
        if (!doc) return;

        document.getElementById("order-doc-id").value = docId;
        document.getElementById("order-doc-name").textContent = doc.name;
        document.getElementById("order-doc-pages").textContent = doc.pages;

        // THÊM: Cập nhật nút xem trước
        const fileUrl = getForcedDownloadLink(doc.url, doc.name);
        const downloadAttr = getDownloadAttribute(doc.url, doc.name);
        const previewBtn = document.getElementById("order-preview-btn");
        previewBtn.href = fileUrl;
        if (downloadAttr) {
          previewBtn.setAttribute("download", downloadAttr);
        } else {
          previewBtn.removeAttribute("download");
        }

        document.getElementById("order-form").reset();
        updateOrderCost();
        showView("order-view");
      }

      document
        .getElementById("order-form")
        .addEventListener("change", updateOrderCost);

      function updateOrderCost() {
        try {
          const pages =
            parseInt(document.getElementById("order-doc-pages").textContent) ||
            0;
          const copies = parseInt(document.getElementById("copies").value) || 1;
          const printType = document.getElementById("print-type").value;
          const paperType = document.getElementById("paper-type").value;
          const total = calculateCost(pages, copies, printType, paperType);
          document.getElementById("total-cost").textContent =
            formatCurrency(total);
        } catch (e) {
          document.getElementById("total-cost").textContent = "Lỗi";
        }
      }

      // Xử lý submit đơn hàng
      document
        .getElementById("order-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // THÊM: Kiểm tra đăng nhập
          if (!checkAuthAndShowLogin()) return;

          const docId = document.getElementById("order-doc-id").value;
          const doc = allDocuments[docId];
          const pages = parseInt(doc.pages);
          const copies = parseInt(document.getElementById("copies").value);
          const paperSize = document.getElementById("paper-size").value;
          const printType = document.getElementById("print-type").value;
          const paperType = document.getElementById("paper-type").value;
          const note = document.getElementById("order-note").value.trim();
          const totalCost = calculateCost(pages, copies, printType, paperType);

          const orderDetails = {
            userId: currentUserId,
            userName: currentUserData.name,
            userClass: currentUserData.class,
            items: [
              {
                docId: docId,
                docName: doc.name,
                pages: pages,
                copies: copies,
                paperSize: paperSize,
                printType: printType,
                paperType: paperType,
              },
            ],
            totalCost: totalCost,
            timestamp: serverTimestamp(),
            createdAt: Date.now(),
            ghiChu: note,
          };
          await processOrderPayment(orderDetails, totalCost);
        });

      // --- LOGIC ĐẶT IN (TÙY CHỌN - Tải File) ---
      const customUploadWidget = cloudinary.createUploadWidget(
        {
          cloudName: CLOUDINARY_CLOUD_NAME,
          uploadPreset: CLOUDINARY_UPLOAD_PRESET,
          multiple: true,
          folder: "user_uploads",
          resourceType: "raw",
          imageMetadata: true,
          sources: ["local", "url"],
          clientAllowedFormats: [
            "pdf",
            "doc",
            "docx",
            "ppt",
            "pptx",
            "xls",
            "xlsx",
            "jpg",
            "png",
            "jpeg",
            "webp",
          ],
        },
        (error, result) => {
          if (!error && result && result.event === "success") {
            customUploadedFiles.push({
              name: result.info.original_filename,
              url: result.info.secure_url,
              publicId: result.info.public_id,
              pages: result.info.pages || 1,
            });
            renderCustomFileList();
            updateCustomOrderCost();
            document.querySelector(
              '#custom-order-form button[type="submit"]'
            ).disabled = false;
          }
        }
      );

      document.getElementById("custom-upload-widget").addEventListener(
        "click",
        () => {
          // THÊM: Kiểm tra đăng nhập trước khi tải file
          if (!checkAuthAndShowLogin()) return;

          customUploadedFiles = [];
          customUploadWidget.open();
        },
        false
      );

      function renderCustomFileList() {
        const list = document.getElementById("custom-file-list");
        list.innerHTML = "";
        if (customUploadedFiles.length === 0) {
          list.innerHTML =
            '<p class="text-sm text-gray-500 text-center">Chưa có file nào được tải lên.</p>';
          return;
        }
        customUploadedFiles.forEach((file, index) => {
          const fileUrl = getForcedDownloadLink(file.url, file.name);
          const downloadAttr = getDownloadAttribute(file.url, file.name);
          const fileEl = document.createElement("div");
          fileEl.className =
            "flex items-center justify-between bg-gray-50 p-3 rounded-md border";
          fileEl.innerHTML = `
                      <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-blue-600 truncate flex-1 mr-4">${file.name}</a>
                      <div class="flex items-center space-x-2">
                          <label class="text-sm">Số trang:</label>
                          <input type="number" class="w-16 p-1 border rounded-md text-sm custom-file-pages" min="1" value="${file.pages}" data-index="${index}">
                      </div>
                  `;
          list.appendChild(fileEl);
        });
      }

      document
        .getElementById("custom-file-list")
        .addEventListener("change", (e) => {
          if (e.target.classList.contains("custom-file-pages")) {
            const index = parseInt(e.target.dataset.index);
            const pages = parseInt(e.target.value) || 1;
            if (pages < 1) e.target.value = 1;
            customUploadedFiles[index].pages = Math.max(1, pages);
            updateCustomOrderCost();
          }
        });

      document
        .getElementById("custom-order-form")
        .addEventListener("change", updateCustomOrderCost);

      function updateCustomOrderCost() {
        try {
          const copies =
            parseInt(document.getElementById("custom-copies").value) || 1;
          const printType = document.getElementById("custom-print-type").value;
          const paperType = document.getElementById("custom-paper-type").value;
          let totalPages = 0;
          customUploadedFiles.forEach((file) => {
            totalPages += parseInt(file.pages) || 0;
          });
          const total = calculateCost(totalPages, copies, printType, paperType);
          document.getElementById("custom-total-cost").textContent =
            formatCurrency(total);
        } catch (e) {
          document.getElementById("custom-total-cost").textContent = "Lỗi";
        }
      }

      document
        .getElementById("custom-order-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // THÊM: Kiểm tra đăng nhập
          if (!checkAuthAndShowLogin()) return;

          if (customUploadedFiles.length === 0) {
            showMessage("Lỗi", "Vui lòng tải lên ít nhất một file.");
            return;
          }

          let totalPages = 0;
          const items = customUploadedFiles.map((file) => {
            const pages = parseInt(file.pages);
            if (!pages || pages < 1) {
              throw new Error(
                `Vui lòng nhập số trang hợp lệ cho file: ${file.name}`
              );
            }
            totalPages += pages;
            return {
              docName: file.name,
              cloudinaryUrl: file.url,
              publicId: file.publicId,
              pages: pages,
            };
          });

          const copies = parseInt(
            document.getElementById("custom-copies").value
          );
          const paperSize = document.getElementById("custom-paper-size").value;
          const printType = document.getElementById("custom-print-type").value;
          const paperType = document.getElementById("custom-paper-type").value;
          const note = document
            .getElementById("custom-order-note")
            .value.trim();
          const totalCost = calculateCost(
            totalPages,
            copies,
            printType,
            paperType
          );

          const finalItems = items.map((item) => ({
            ...item,
            copies: copies,
            paperSize: paperSize,
            printType: printType,
            paperType: paperType,
          }));

          const orderDetails = {
            userId: currentUserId,
            userName: currentUserData.name,
            userClass: currentUserData.class,
            items: finalItems,
            totalCost: totalCost,
            timestamp: serverTimestamp(),
            createdAt: Date.now(),
            ghiChu: note,
          };

          try {
            await processOrderPayment(orderDetails, totalCost);
            customUploadedFiles = [];
            renderCustomFileList();
            document.getElementById("custom-order-form").reset();
            updateCustomOrderCost();
            document.querySelector(
              '#custom-order-form button[type="submit"]'
            ).disabled = true;
          } catch (error) {
            showMessage("Lỗi Đặt Hàng", error.message);
          }
        });

      // --- THÊM: LOGIC VIEW IN NHANH ---

      // Render view In Nhanh
      function renderQuickPrintView() {
        const list = document.getElementById("quick-print-list");
        list.innerHTML = "";

        if (quickPrintCart.length === 0) {
          list.innerHTML =
            '<p class="text-gray-500 text-center">Giỏ hàng In Nhanh của bạn đang trống. Vui lòng quay lại Trang Chủ và bật chế độ "In Nhanh" để thêm tài liệu.</p>';
          document.getElementById("quick-print-form").reset();
          updateQuickPrintCost();
          return;
        }

        quickPrintCart.forEach((docId) => {
          const doc = allDocuments[docId];
          if (!doc) return;

          const fileUrl = getForcedDownloadLink(doc.url, doc.name);
          const downloadAttr = getDownloadAttribute(doc.url, doc.name);

          const itemEl = document.createElement("div");
          itemEl.className =
            "flex items-center justify-between bg-gray-50 p-3 rounded-md border";
          itemEl.innerHTML = `
                      <div class="flex-1 min-w-0 mr-4">
                          <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-blue-600 truncate" title="${doc.name}">${doc.name}</a>
                          <p class="text-xs text-gray-500">${doc.pages} trang</p>
                      </div>
                      <button type="button" class="remove-quick-print-item text-red-500 hover:text-red-700 font-bold text-lg" data-doc-id="${docId}">&times;</button>
                  `;
          list.appendChild(itemEl);
        });
        updateQuickPrintCost();
      }

      // Xóa item khỏi giỏ In Nhanh
      document
        .getElementById("quick-print-list")
        .addEventListener("click", (e) => {
          const removeBtn = e.target.closest(".remove-quick-print-item");
          if (removeBtn) {
            const docId = removeBtn.dataset.docId;
            toggleQuickPrintItem(docId, false); // Tắt (false)
            renderQuickPrintView(); // Vẽ lại list
            updateQuickPrintCartCount(); // Cập nhật nút
          }
        });

      // Cập nhật chi phí In Nhanh
      document
        .getElementById("quick-print-form")
        .addEventListener("change", updateQuickPrintCost);

      function updateQuickPrintCost() {
        try {
          const copies =
            parseInt(document.getElementById("quick-print-copies").value) || 1;
          const printType = document.getElementById(
            "quick-print-print-type"
          ).value;
          const paperType = document.getElementById(
            "quick-print-paper-type"
          ).value;

          let totalPages = 0;
          quickPrintCart.forEach((docId) => {
            const doc = allDocuments[docId];
            if (doc) {
              totalPages += parseInt(doc.pages) || 0;
            }
          });

          const total = calculateCost(totalPages, copies, printType, paperType);
          document.getElementById("quick-print-total-cost").textContent =
            formatCurrency(total);
        } catch (e) {
          document.getElementById("quick-print-total-cost").textContent = "Lỗi";
        }
      }

      // Submit đơn hàng In Nhanh
      document
        .getElementById("quick-print-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          // THÊM: Kiểm tra đăng nhập
          if (!checkAuthAndShowLogin()) return;

          if (quickPrintCart.length === 0) {
            showMessage("Lỗi", "Giỏ hàng In Nhanh đang trống.");
            return;
          }

          const copies = parseInt(
            document.getElementById("quick-print-copies").value
          );
          const paperSize = document.getElementById(
            "quick-print-paper-size"
          ).value;
          const printType = document.getElementById(
            "quick-print-print-type"
          ).value;
          const paperType = document.getElementById(
            "quick-print-paper-type"
          ).value;
          const note = document.getElementById("quick-print-note").value.trim();

          let totalCost = 0;
          const items = [];
          quickPrintCart.forEach((docId) => {
            const doc = allDocuments[docId];
            if (doc) {
              const pages = parseInt(doc.pages);
              totalCost += calculateCost(pages, copies, printType, paperType);
              items.push({
                docId: docId,
                docName: doc.name,
                pages: pages,
                copies: copies,
                paperSize: paperSize,
                printType: printType,
                paperType: paperType,
              });
            }
          });

          if (items.length === 0) {
            showMessage("Lỗi", "Không có tài liệu hợp lệ trong giỏ.");
            return;
          }

          const orderDetails = {
            userId: currentUserId,
            userName: currentUserData.name,
            userClass: currentUserData.class,
            items: items,
            totalCost: totalCost,
            timestamp: serverTimestamp(),
            createdAt: Date.now(),
            ghiChu: note,
          };

          try {
            await processOrderPayment(orderDetails, totalCost);
            // Reset giỏ hàng
            quickPrintCart = [];
            updateQuickPrintCartCount();
            if (isQuickPrintMode) {
              toggleQuickPrintMode(); // Tắt chế độ In Nhanh
            } else {
              renderDocumentGrid(); // Cập nhật lại grid
            }
          } catch (error) {
            showMessage("Lỗi Đặt Hàng", error.message);
          }
        });

      // --- LOGIC THANH TOÁN & SỐ DƯ ---

      async function processOrderPayment(orderDetails, totalCost) {
        showLoading(true);
        try {
          const userBalance = currentUserData.balance || 0;
          const userRef = ref(db, `artifacts/${appId}/users/${currentUserId}`);

          if (userBalance >= totalCost) {
            const newBalance = userBalance - totalCost;
            await update(userRef, { balance: newBalance });
            orderDetails.paymentStatus = "paid";
            orderDetails.amountPaid = totalCost;
            orderDetails.amountDue = 0;
            orderDetails.isPrinted = false;
            showMessage(
              "Thành Công",
              `Đặt hàng thành công! Đã thanh toán bằng số dư. Số dư còn lại: ${formatCurrency(
                newBalance
              )}đ`
            );
          } else {
            const amountDue = totalCost - userBalance;
            const amountPaidFromBalance = userBalance;
            await update(userRef, { balance: 0 });
            orderDetails.paymentStatus = "pending";
            orderDetails.amountPaid = amountPaidFromBalance;
            orderDetails.amountDue = amountDue;
            orderDetails.isPrinted = false;
            showMessage(
              "Đặt Hàng Thành Công",
              `Đã dùng ${formatCurrency(
                amountPaidFromBalance
              )}đ từ số dư. Vui lòng thanh toán thêm ${formatCurrency(
                amountDue
              )}đ tại quầy.`
            );
          }

          const newOrderRef = push(ref(db, `artifacts/${appId}/public/orders`));
          await set(newOrderRef, orderDetails);

          sendDiscordNotification(orderDetails, newOrderRef.key);
          showView("history-view");
        } catch (error) {
          console.error("Lỗi xử lý thanh toán:", error);
          showMessage("Lỗi", "Đã xảy ra lỗi khi xử lý đơn hàng của bạn.");
        } finally {
          showLoading(false);
        }
      }

      // --- LOGIC LỊCH SỬ USER ---

      // ĐÃ SỬA: Thêm tính toán tổng tiền
      function renderUserHistory() {
        // THÊM: Nếu là khách, không render gì cả
        if (currentUserData.isGuest) {
          document.getElementById("history-table-body").innerHTML =
            '<tr><td colspan="7" class="text-center p-6 text-gray-500">Vui lòng đăng nhập để xem lịch sử.</td></tr>';
          document.getElementById("history-total-spent").textContent = "0đ";
          document.getElementById("history-total-due").textContent = "0đ";
          return;
        }

        const tbody = document.getElementById("history-table-body");
        tbody.innerHTML = "";

        const activeTab =
          document.querySelector(".history-tab.text-blue-600")?.dataset.tab ||
          "all";

        let userOrders = Object.entries(allOrders).filter(
          ([id, order]) => order.userId === currentUserId
        );

        // THÊM: Tính toán tổng chi và tổng nợ (trước khi lọc theo tab)
        let totalSpent = 0;
        let totalDue = 0;
        userOrders.forEach(([, order]) => {
          if (order.paymentStatus !== "replaced") {
            totalSpent += order.amountPaid || 0;
            if (order.paymentStatus === "pending") {
              totalDue += order.amountDue || 0;
            }
          }
        });
        document.getElementById(
          "history-total-spent"
        ).textContent = `${formatCurrency(totalSpent)}đ`;
        document.getElementById(
          "history-total-due"
        ).textContent = `${formatCurrency(totalDue)}đ`;

        // Lọc theo tab
        switch (activeTab) {
          case "pending":
            userOrders = userOrders.filter(
              ([, order]) => order.paymentStatus === "pending"
            );
            break;
          case "processing":
            userOrders = userOrders.filter(
              ([, order]) => order.paymentStatus === "paid" && !order.isPrinted
            );
            break;
          case "completed":
            userOrders = userOrders.filter(
              ([, order]) =>
                order.isPrinted && order.paymentStatus !== "replaced"
            );
            break;
          case "replaced":
            userOrders = userOrders.filter(
              ([, order]) => order.paymentStatus === "replaced"
            );
            break;
        }

        userOrders.sort(([, a], [, b]) => b.timestamp - a.timestamp);

        if (userOrders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" class="text-center p-6 text-gray-500">Không có đơn hàng nào trong mục này.</td></tr>';
          return;
        }

        userOrders.forEach(([id, order]) => {
          const tr = document.createElement("tr");

          const itemsHtml = order.items
            .map((item) => {
              let url = "#";
              let name = item.docName;
              if (item.cloudinaryUrl) {
                url = item.cloudinaryUrl;
              } else if (item.docId && allDocuments[item.docId]) {
                url = allDocuments[item.docId].url;
              }
              const fileUrl = getForcedDownloadLink(url, name);
              const downloadAttr = getDownloadAttribute(url, name);
              return `<div>- <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline" title="Xem/Tải file">${item.docName}</a> (x${item.copies}, ${item.printType}, ${item.paperType})</div>`;
            })
            .join("");

          const noteHtml = order.ghiChu
            ? `<div class="mt-2 text-xs text-red-600"><strong>Ghi chú:</strong> ${order.ghiChu}</div>`
            : "";

          let paymentStatusHtml = "";
          if (order.paymentStatus === "paid") {
            paymentStatusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Đã thanh toán</span>`;
          } else if (order.paymentStatus === "pending") {
            paymentStatusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Chờ thanh toán (Còn ${formatCurrency(
              order.amountDue || 0
            )}đ)</span>`;
          } else if (order.paymentStatus === "replaced") {
            paymentStatusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Đã thay thế</span>`;
          }

          let printStatusHtml = order.isPrinted
            ? `<span class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Đã In</span>`
            : `<span class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Chưa In</span>`;
          const statusHtml = `<div class="flex flex-col items-start">${paymentStatusHtml}${printStatusHtml}</div>`;

          let cancelActionHtml = "";
          if (order.paymentStatus === "replaced") {
            cancelActionHtml = `<span class="text-xs text-gray-500">Đã thay thế</span>`;
          } else if (order.isPrinted) {
            cancelActionHtml = `<span class="text-xs text-gray-500">Đã In</span>`;
          } else if (order.paymentStatus === "pending") {
            cancelActionHtml = `<button class="text-xs font-medium text-red-600 hover:text-red-800 user-cancel-order" data-order-id="${id}">Hủy Đơn</button>`;
          } else if (order.paymentStatus === "paid") {
            if (order.isEdited) {
              cancelActionHtml = `<span class="text-xs text-gray-500">Không thể hủy (Đã sửa)</span>`;
            } else {
              cancelActionHtml = `<button class="text-xs font-medium text-orange-600 hover:text-orange-800 user-refund-order" data-order-id="${id}" data-cost="${order.totalCost}">Hủy & Hoàn Tiền</button>`;
            }
          }

          const viewButtonHtml = `<button class="text-xs font-medium text-blue-600 hover:text-blue-800 view-order-details" data-order-id="${id}">Xem</button>`;
          const canEdit =
            !order.isPrinted && order.paymentStatus !== "replaced";
          const editButtonHtml = `<button class="text-xs font-medium text-blue-600 hover:text-blue-800 user-edit-order" data-order-id="${id}" ${
            !canEdit ? "disabled" : ""
          }>${canEdit ? "Sửa" : "Không thể sửa"}</button>`;

          tr.innerHTML = `
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(
                        order.timestamp
                      )}</td>
                      <td class="px-6 py-4 text-sm text-gray-900">${itemsHtml}${noteHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 font-medium">${formatCurrency(
                        order.totalCost
                      )}đ</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">${statusHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${viewButtonHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${editButtonHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-center">${cancelActionHtml}</td>
                  `;
          tbody.appendChild(tr);
        });
      }

      document
        .getElementById("history-table-body")
        .addEventListener("click", async (e) => {
          const editBtn = e.target.closest(".user-edit-order:not(:disabled)");
          if (editBtn) {
            const orderId = editBtn.dataset.orderId;
            openEditOrderModal(orderId);
            return;
          }

          const cancelBtn = e.target.closest(".user-cancel-order");
          if (cancelBtn) {
            const orderId = cancelBtn.dataset.orderId;
            const order = allOrders[orderId];
            if (
              order &&
              (order.isPrinted || order.paymentStatus === "replaced")
            ) {
              showMessage("Lỗi", "Không thể hủy đơn hàng này.");
              return;
            }
            if (
              await showConfirm(
                "Xác nhận hủy",
                "Bạn có chắc muốn hủy đơn hàng này? Đơn hàng sẽ bị xóa vĩnh viễn."
              )
            ) {
              showLoading(true);
              try {
                await remove(
                  ref(db, `artifacts/${appId}/public/orders/${orderId}`)
                );
                showMessage("Thành Công", "Đã hủy đơn hàng.");
              } catch (error) {
                showMessage("Lỗi", "Không thể hủy đơn hàng.");
              } finally {
                showLoading(false);
              }
            }
          }

          const refundBtn = e.target.closest(".user-refund-order");
          if (refundBtn) {
            const orderId = refundBtn.dataset.orderId;
            const order = allOrders[orderId];
            if (
              order &&
              (order.isPrinted ||
                order.paymentStatus === "replaced" ||
                order.isEdited)
            ) {
              showMessage(
                "Lỗi",
                "Không thể hủy đơn hàng đã được in hoặc chỉnh sửa."
              );
              return;
            }
            const costToRefund = parseFloat(refundBtn.dataset.cost);
            if (
              await showConfirm(
                "Xác nhận hủy",
                `Bạn có chắc muốn hủy đơn hàng này? Số tiền ${formatCurrency(
                  costToRefund
                )}đ sẽ được hoàn vào số dư của bạn.`
              )
            ) {
              showLoading(true);
              try {
                const userBalance = currentUserData.balance || 0;
                const newBalance = userBalance + costToRefund;
                await update(
                  ref(db, `artifacts/${appId}/users/${currentUserId}`),
                  { balance: newBalance }
                );
                await remove(
                  ref(db, `artifacts/${appId}/public/orders/${orderId}`)
                );
                showMessage(
                  "Thành Công",
                  `Đã hủy đơn và hoàn ${formatCurrency(
                    costToRefund
                  )}đ vào số dư. Số dư mới: ${formatCurrency(newBalance)}đ`
                );
              } catch (error) {
                showMessage("Lỗi", "Không thể hủy và hoàn tiền.");
              } finally {
                showLoading(false);
              }
            }
          }
        });

      // --- LOGIC ADMIN: QUẢN LÝ TÀI LIỆU ---

      let adminFile = {};
      const adminUploadWidget = cloudinary.createUploadWidget(
        {
          cloudName: CLOUDINARY_CLOUD_NAME,
          uploadPreset: CLOUDINARY_UPLOAD_PRESET,
          multiple: false,
          folder: "admin_documents",
          resourceType: "raw",
          imageMetadata: true,
        },
        (error, result) => {
          if (!error && result && result.event === "success") {
            adminFile = {
              url: result.info.secure_url,
              publicId: result.info.public_id,
            };
            document.getElementById(
              "admin-file-url"
            ).textContent = `Đã tải lên: ${result.info.original_filename}`;
            document.getElementById("admin-doc-url").value = adminFile.url;
            document.getElementById("admin-doc-public-id").value =
              adminFile.publicId;

            if (result.info.pages) {
              document.getElementById("admin-doc-pages").value =
                result.info.pages;
              document
                .getElementById("admin-doc-pages")
                .classList.add("bg-green-50", "border-green-300");
            } else {
              document
                .getElementById("admin-doc-pages")
                .classList.remove("bg-green-50", "border-green-300");
            }
          }
        }
      );

      document
        .getElementById("admin-upload-widget")
        .addEventListener("click", () => adminUploadWidget.open(), false);

      document
        .getElementById("admin-doc-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const docId = document.getElementById("admin-doc-id").value;
          const name = document.getElementById("admin-doc-name").value;
          const folderPath = document
            .getElementById("admin-doc-folder")
            .value.trim();
          const pages = parseInt(
            document.getElementById("admin-doc-pages").value
          );
          const url = document.getElementById("admin-doc-url").value;
          const publicId = document.getElementById("admin-doc-public-id").value;

          if (!name || !pages || !url) {
            showMessage("Lỗi", "Vui lòng nhập Tên, Số trang và Tải file lên.");
            return;
          }

          const docData = { name, folderPath, pages, url, publicId };
          showLoading(true);
          try {
            if (docId) {
              const docRef = ref(
                db,
                `artifacts/${appId}/public/documents/${docId}`
              );
              await update(docRef, docData);
              showMessage("Thành Công", "Đã cập nhật tài liệu.");
            } else {
              const docsRef = ref(db, `artifacts/${appId}/public/documents`);
              const newDocRef = push(docsRef);
              await set(newDocRef, docData);
              showMessage("Thành Công", "Đã thêm tài liệu mới.");
            }
            resetAdminDocForm();
          } catch (error) {
            showMessage("Lỗi", "Không thể lưu tài liệu.");
          } finally {
            showLoading(false);
          }
        });

      function renderAdminDocList() {
        const list = document.getElementById("admin-doc-list");
        list.innerHTML = "";
        const searchTerm = document
          .getElementById("admin-search-bar")
          .value.toLowerCase();
        const filteredDocs = Object.entries(allDocuments).filter(
          ([id, doc]) => {
            const name = doc.name?.toLowerCase() || "";
            const folder = doc.folderPath?.toLowerCase() || "";
            return name.includes(searchTerm) || folder.includes(searchTerm);
          }
        );

        const sortedDocs = filteredDocs.sort(([, a], [, b]) => {
          const folderCompare = (a.folderPath || "").localeCompare(
            b.folderPath || ""
          );
          if (folderCompare !== 0) return folderCompare;
          return (a.name || "").localeCompare(b.name || "");
        });

        if (sortedDocs.length === 0) {
          list.innerHTML =
            '<p class="text-sm text-gray-500">Không tìm thấy tài liệu nào.</p>';
          return;
        }

        sortedDocs.forEach(([id, doc]) => {
          const item = document.createElement("div");
          item.className =
            "flex justify-between items-center p-3 bg-gray-50 rounded-md border";
          item.innerHTML = `
                      <div class="flex-1 truncate mr-4">
                          <p class="text-sm font-medium text-gray-900">${
                            doc.name
                          }</p>
                          <p class="text-xs text-gray-500">${
                            doc.folderPath || "/"
                          } - ${doc.pages} trang</p>
                      </div>
                      <div class="flex-shrink-0 space-x-2">
                          <button class="text-xs text-blue-600 hover:text-blue-800" data-id="${id}">Sửa</button>
                          <button class="text-xs text-red-600 hover:text-red-800" data-id="${id}">Xóa</button>
                      </div>
                  `;
          item
            .querySelector("button.text-blue-600")
            .addEventListener("click", () => {
              prepareEditDoc(id, doc);
            });
          item
            .querySelector("button.text-red-600")
            .addEventListener("click", async () => {
              if (
                await showConfirm(
                  "Xác nhận xóa",
                  `Bạn có chắc chắn muốn xóa tài liệu "${doc.name}" không?`
                )
              ) {
                deleteDocument(id, doc.publicId);
              }
            });
          list.appendChild(item);
        });
      }

      function prepareEditDoc(id, doc) {
        document.getElementById("admin-form-title").textContent =
          "Sửa Tài Liệu";
        document.getElementById("admin-doc-id").value = id;
        document.getElementById("admin-doc-name").value = doc.name;
        document.getElementById("admin-doc-folder").value =
          doc.folderPath || "";
        document.getElementById("admin-doc-pages").value = doc.pages;
        document.getElementById("admin-doc-url").value = doc.url;
        document.getElementById("admin-doc-public-id").value = doc.publicId;
        document.getElementById(
          "admin-file-url"
        ).textContent = `File hiện tại: ${doc.url.split("/").pop()}`;
        document.getElementById("admin-cancel-edit").classList.remove("hidden");
        window.scrollTo(0, 0);
      }

      document
        .getElementById("admin-cancel-edit")
        .addEventListener("click", resetAdminDocForm);

      function resetAdminDocForm() {
        document.getElementById("admin-form-title").textContent =
          "Thêm Tài Liệu Mới";
        document.getElementById("admin-doc-form").reset();
        document.getElementById("admin-doc-id").value = "";
        document.getElementById("admin-doc-url").value = "";
        document.getElementById("admin-doc-public-id").value = "";
        document.getElementById("admin-file-url").textContent = "";
        document.getElementById("admin-cancel-edit").classList.add("hidden");
        document
          .getElementById("admin-doc-pages")
          .classList.remove("bg-green-50", "border-green-300");
        adminFile = {};
      }

      async function deleteDocument(id, publicId) {
        showLoading(true);
        try {
          const docRef = ref(db, `artifacts/${appId}/public/documents/${id}`);
          await remove(docRef);
          showMessage("Thành Công", "Đã xóa tài liệu.");
          console.warn(
            `Đã xóa doc ${id} trên RTDB. Vui lòng xóa file trên Cloudinary với public_id: ${publicId}`
          );
        } catch (error) {
          showMessage("Lỗi", "Không thể xóa tài liệu.");
        } finally {
          showLoading(false);
        }
      }

      // --- LOGIC ADMIN: QUẢN LÝ ĐƠN HÀNG ---

      function renderAdminOrdersTable() {
        const tbody = document.getElementById("admin-orders-table-body");
        tbody.innerHTML = "";
        const sortedOrders = Object.entries(allOrders).sort(
          ([, a], [, b]) => b.timestamp - a.timestamp
        );

        if (sortedOrders.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="9" class="text-center p-6 text-gray-500">Không có đơn hàng nào.</td></tr>';
          return;
        }

        sortedOrders.forEach(([id, order]) => {
          const tr = document.createElement("tr");
          if (order.paymentStatus === "replaced") {
            tr.className = "bg-gray-100 opacity-60";
          } else if (order.isPrinted) {
            tr.className = "bg-blue-50";
          } else if (order.paymentStatus === "pending") {
            tr.className = "bg-yellow-50";
          } else {
            tr.className = "bg-green-50";
          }

          const itemsHtml = order.items
            .map((item) => {
              let url = "#";
              let name = item.docName;
              if (item.cloudinaryUrl) {
                url = item.cloudinaryUrl;
              } else if (item.docId && allDocuments[item.docId]) {
                url = allDocuments[item.docId].url;
              }
              const fileUrl = getForcedDownloadLink(url, name);
              const downloadAttr = getDownloadAttribute(url, name);
              return `<div>- <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline" title="Xem/Tải file">${item.docName}</a> (x${item.copies})</div>`;
            })
            .join("");

          const noteHtml = order.ghiChu
            ? `<div class="mt-2 text-sm text-red-600 font-medium"><strong>Ghi chú:</strong> ${order.ghiChu}</div>`
            : "";

          let paymentStatusHtml = "";
          if (order.paymentStatus === "paid") {
            paymentStatusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Đã thanh toán</span>`;
          } else if (order.paymentStatus === "pending") {
            paymentStatusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Chờ thanh toán (Còn ${formatCurrency(
              order.amountDue || 0
            )}đ)</span>`;
          } else if (order.paymentStatus === "replaced") {
            paymentStatusHtml = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Đã thay thế</span>`;
          }

          let printStatusHtml = order.isPrinted
            ? `<span class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Đã In</span>`
            : `<span class="mt-1 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">Chưa In</span>`;
          const statusHtml = `<div class="flex flex-col items-start">${paymentStatusHtml}${printStatusHtml}</div>`;

          let paymentActionHtml = "";
          if (order.paymentStatus === "pending") {
            paymentActionHtml = `<button class="text-sm font-medium text-blue-600 hover:text-blue-800 admin-mark-paid" data-id="${id}" data-user-id="${order.userId}">Đánh Dấu Đã Trả</button>`;
          } else if (order.paymentStatus === "replaced") {
            paymentActionHtml = `<span class="text-xs text-gray-500">Đã thay thế</span>`;
          } else {
            paymentActionHtml = `<span class="text-xs text-gray-500">Đã Trả</span>`;
          }

          let printActionHtml = "";
          if (order.paymentStatus === "replaced") {
            printActionHtml = `<span class="text-xs text-gray-500">Đã thay thế</span>`;
          } else if (!order.isPrinted) {
            printActionHtml = `<button class="text-sm font-medium text-green-600 hover:text-green-800 admin-mark-printed" data-id="${id}">Đánh Dấu Đã In</button>`;
          } else {
            printActionHtml = `<span class="text-xs text-gray-500">Đã In</span>`;
          }

          const viewButtonHtml = `<button class="text-sm font-medium text-gray-600 hover:text-blue-600 view-order-details" data-order-id="${id}">Xem</button>`;
          const canEdit =
            !order.isPrinted && order.paymentStatus !== "replaced";
          const editButtonHtml = `<button class="text-sm font-medium text-blue-600 hover:text-blue-800 admin-edit-order" data-order-id="${id}" ${
            !canEdit ? "disabled" : ""
          }>${canEdit ? "Sửa" : "Không thể sửa"}</button>`;

          tr.innerHTML = `
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatDate(
                        order.timestamp
                      )}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${
                        order.userName
                      } (${order.userClass})</td>
                      <td class="px-6 py-4 text-sm text-gray-700">${itemsHtml}${noteHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-bold">${formatCurrency(
                        order.totalCost
                      )}đ</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">${statusHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">${viewButtonHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">${editButtonHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">${paymentActionHtml}</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm">${printActionHtml}</td>
                  `;
          tbody.appendChild(tr);
        });
      }

      document
        .getElementById("admin-orders-table-body")
        .addEventListener("click", async (e) => {
          const editBtn = e.target.closest(".admin-edit-order:not(:disabled)");
          if (editBtn) {
            const orderId = editBtn.dataset.orderId;
            openEditOrderModal(orderId);
            return;
          }

          const paidBtn = e.target.closest(".admin-mark-paid");
          if (paidBtn) {
            const orderId = paidBtn.dataset.id;
            const userId = paidBtn.dataset.userId;
            const order = allOrders[orderId];
            if (!order) return;

            const totalCost = order.totalCost;
            const amountDue = order.amountDue || 0;
            const amountPaidFromBalance = order.amountPaid || 0;

            const amountPaidStr = await showPrompt(
              "Xác Nhận Thanh Toán",
              `Đơn hàng #${orderId.slice(-5)} - ${
                order.userName
              }\nTổng tiền: ${formatCurrency(
                totalCost
              )}đ\nĐã trả (số dư): ${formatCurrency(
                amountPaidFromBalance
              )}đ\nCần thu thêm: ${formatCurrency(
                amountDue
              )}đ\n\nNhập số tiền khách trả:`,
              amountDue
            );

            if (amountPaidStr !== null) {
              const amountCollected = parseFloat(amountPaidStr);
              if (!isNaN(amountCollected) && amountCollected >= amountDue) {
                markOrderAsPaid(
                  orderId,
                  userId,
                  totalCost,
                  amountDue,
                  amountCollected
                );
              } else {
                showMessage(
                  "Lỗi",
                  `Số tiền trả phải là một số và lớn hơn hoặc bằng số tiền còn thiếu (${formatCurrency(
                    amountDue
                  )}đ).`
                );
              }
            }
          }

          const printBtn = e.target.closest(".admin-mark-printed");
          if (printBtn) {
            const orderId = printBtn.dataset.id;
            if (
              await showConfirm(
                "Xác nhận đã in",
                "Xác nhận đơn hàng này đã được in xong? User sẽ không thể hủy hoặc sửa đơn này nữa."
              )
            ) {
              showLoading(true);
              try {
                await update(
                  ref(db, `artifacts/${appId}/public/orders/${orderId}`),
                  { isPrinted: true }
                );
                showMessage(
                  "Thành Công",
                  "Đã cập nhật trạng thái đơn hàng thành 'Đã In'."
                );
              } catch (error) {
                showMessage("Lỗi", "Không thể cập nhật trạng thái.");
              } finally {
                showLoading(false);
              }
            }
          }
        });

      async function markOrderAsPaid(
        orderId,
        userId,
        totalCost,
        amountDue,
        amountCollected
      ) {
        showLoading(true);
        try {
          const balanceToAdd = amountCollected - amountDue;
          const userRef = ref(db, `artifacts/${appId}/users/${userId}`);
          const userSnap = await get(userRef);
          let currentBalance = 0;
          if (userSnap.exists()) {
            currentBalance = userSnap.val().balance || 0;
          }
          const newBalance = currentBalance + balanceToAdd;
          await update(userRef, { balance: newBalance });

          const orderRef = ref(
            db,
            `artifacts/${appId}/public/orders/${orderId}`
          );
          await update(orderRef, {
            paymentStatus: "paid",
            amountPaid: totalCost,
            amountDue: 0,
            amountCollected: amountCollected,
          });
          showMessage(
            "Thành Công",
            `Đã xác nhận thanh toán. Cộng ${formatCurrency(
              balanceToAdd
            )}đ vào số dư của user. Số dư mới: ${formatCurrency(newBalance)}đ`
          );
        } catch (error) {
          showMessage("Lỗi", "Không thể xác nhận thanh toán.");
        } finally {
          showLoading(false);
        }
      }

      // --- THÊM: LOGIC ADMIN - QUẢN LÝ USER ---
      // THAY ĐỔI: Gỡ bỏ điều kiện lọc "Admin"
      function renderAdminUsersTable() {
        // Chờ cả 2 nguồn dữ liệu
        if (!allUsersData || !allOrders) return;

        const tbody = document.getElementById("admin-users-table-body");
        tbody.innerHTML = "";

        // Sắp xếp user theo tên
        const sortedUsers = Object.entries(allUsersData).sort(([, a], [, b]) =>
          (a.name || "").localeCompare(b.name || "")
        );

        sortedUsers.forEach(([userId, user]) => {
          // BỎ LỌC ADMIN: if (user.name === "Admin") return;

          let totalSpent = 0;
          let totalDue = 0;

          // Tính toán từ allOrders
          Object.values(allOrders).forEach((order) => {
            if (order.userId === userId && order.paymentStatus !== "replaced") {
              totalSpent += order.amountPaid || 0;
              if (order.paymentStatus === "pending") {
                totalDue += order.amountDue || 0;
              }
            }
          });

          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";
          tr.innerHTML = `
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                        user.name
                      }</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                        user.class
                      }</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600">${formatCurrency(
                        user.balance || 0
                      )}đ</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-700">${formatCurrency(
                        totalSpent
                      )}đ</td>
                      <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-700">${formatCurrency(
                        totalDue
                      )}đ</td>
                  `;
          tbody.appendChild(tr);
        });
      }

      // --- LOGIC ADMIN: BÁO CÁO ---

      function setupReportMonths() {
        const select = document.getElementById("report-month");
        select.innerHTML = '<option value="all">Toàn bộ thời gian</option>';
        const monthNames = [
          "1",
          "2",
          "3",
          "4",
          "5",
          "6",
          "7",
          "8",
          "9",
          "10",
          "11",
          "12",
        ];
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const monthYear = `${d.getFullYear()}-${String(
            d.getMonth() + 1
          ).padStart(2, "0")}`;
          const monthName = `Tháng ${
            monthNames[d.getMonth()]
          } / ${d.getFullYear()}`;
          select.innerHTML += `<option value="${monthYear}">${monthName}</option>`;
        }
        select.addEventListener("change", renderAdminReports);
      }

      function renderAdminReports() {
        const selectedMonth = document.getElementById("report-month").value;
        document.getElementById("report-month-display").textContent =
          selectedMonth === "all" ? "Toàn Bộ" : selectedMonth;

        let totalRevenue = 0;
        const paidOrders = [];
        const unpaidOrders = [];

        Object.values(allOrders).forEach((order) => {
          if (order.paymentStatus === "replaced") {
            return;
          }
          const orderDate = new Date(order.timestamp);
          const orderMonthYear = `${orderDate.getFullYear()}-${String(
            orderDate.getMonth() + 1
          ).padStart(2, "0")}`;

          if (
            order.paymentStatus === "paid" ||
            order.paymentStatus === "printed"
          ) {
            if (selectedMonth === "all" || orderMonthYear === selectedMonth) {
              totalRevenue += order.totalCost;
              paidOrders.push(order);
            }
          } else if (order.paymentStatus === "pending") {
            unpaidOrders.push(order);
          }
        });

        document.getElementById("report-total-revenue").textContent =
          formatCurrency(totalRevenue);

        const paidBody = document.getElementById("report-paid-body");
        paidBody.innerHTML = "";
        paidOrders
          .sort((a, b) => b.timestamp - a.timestamp)
          .forEach((order) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                      <td class="px-4 py-2 text-sm text-gray-500">${formatDate(
                        order.timestamp
                      )}</td>
                      <td class="px-4 py-2 text-sm text-gray-900">${
                        order.userName
                      } (${order.userClass})</td>
                      <td class="px-4 py-2 text-sm text-gray-900 font-medium">${formatCurrency(
                        order.totalCost
                      )}đ</td>
                  `;
            paidBody.appendChild(tr);
          });

        const unpaidBody = document.getElementById("report-unpaid-body");
        unpaidBody.innerHTML = "";
        unpaidOrders
          .sort((a, b) => b.timestamp - a.timestamp)
          .forEach((order) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                      <td class="px-4 py-2 text-sm text-gray-500">${formatDate(
                        order.timestamp
                      )}</td>
                      <td class="px-4 py-2 text-sm text-red-700">${
                        order.userName
                      } (${order.userClass})</td>
                      <td class="px-4 py-2 text-sm text-red-700 font-medium">${formatCurrency(
                        order.totalCost
                      )}đ (Còn nợ ${formatCurrency(order.amountDue || 0)})</td>
                  `;
            unpaidBody.appendChild(tr);
          });
      }

      document
        .getElementById("export-excel-btn")
        .addEventListener("click", () => {
          try {
            const wb = XLSX.utils.book_new();
            const paidData = Array.from(
              document.getElementById("report-paid-body").rows
            ).map((row) => ({
              Ngày: row.cells[0].textContent,
              "Người Đặt": row.cells[1].textContent,
              "Số Tiền (VND)": parseFloat(
                row.cells[2].textContent.replace(/[.,đ]/g, "")
              ),
            }));
            const wsPaid = XLSX.utils.json_to_sheet(paidData);
            XLSX.utils.book_append_sheet(wb, wsPaid, "DaThanhToan");

            const unpaidData = Array.from(
              document.getElementById("report-unpaid-body").rows
            ).map((row) => ({
              Ngày: row.cells[0].textContent,
              "Người Đặt": row.cells[1].textContent,
              "Số Tiền (VND)": row.cells[2].textContent,
            }));
            const wsUnpaid = XLSX.utils.json_to_sheet(unpaidData);
            XLSX.utils.book_append_sheet(wb, wsUnpaid, "ChuaThanhToan");

            const revenue = document.getElementById(
              "report-total-revenue"
            ).textContent;
            const month = document.getElementById(
              "report-month-display"
            ).textContent;
            const wsSummary = XLSX.utils.json_to_sheet([
              { "Báo Cáo Tháng": month },
              { "Tổng Doanh Thu": revenue },
            ]);
            XLSX.utils.book_append_sheet(wb, wsSummary, "TongQuan");

            const fileName = `BaoCao_InAn_Thang_${
              document.getElementById("report-month").value
            }.xlsx`;
            XLSX.writeFile(wb, fileName);
          } catch (error) {
            console.error("Lỗi xuất Excel:", error);
          }
        });

      // --- HÀM GỬI THÔNG BÁO DISCORD ---
      async function sendDiscordNotification(order, orderId, isEdit = false) {
        if (!DISCORD_WEBHOOK_URL) {
          console.log("Chưa cấu hình Discord Webhook, bỏ qua thông báo.");
          return;
        }
        try {
          const itemsDescription = order.items
            .map((item) => {
              let url = "#";
              if (item.cloudinaryUrl) url = item.cloudinaryUrl;
              else if (item.docId && allDocuments[item.docId])
                url = allDocuments[item.docId].url;
              const fileUrl = getForcedDownloadLink(url, item.docName);
              return `- [${item.docName}](${fileUrl}) (x${item.copies}, ${item.pages} trang, ${item.printType}, ${item.paperType})`;
            })
            .join("\n");

          let statusText = "";
          if (order.paymentStatus === "paid") {
            statusText = "✅ Đã thanh toán (Bằng số dư)";
          } else if (order.paymentStatus === "pending") {
            statusText = `⌛ Chờ thanh toán (Còn thiếu ${formatCurrency(
              order.amountDue || 0
            )}đ)`;
          }

          const fields = [
            {
              name: "Người Đặt",
              value: `${order.userName} (${order.userClass})`,
              inline: true,
            },
            { name: "Trạng Thái", value: statusText, inline: true },
            {
              name: "Tổng Tiền",
              value: `${formatCurrency(order.totalCost)}đ`,
              inline: true,
            },
            {
              name: "Chi Tiết Đơn Hàng",
              value: itemsDescription,
              inline: false,
            },
          ];
          if (order.ghiChu) {
            fields.push({
              name: "📝 Ghi Chú Đặc Biệt",
              value: order.ghiChu,
              inline: false,
            });
          }

          const title = isEdit
            ? `✏️ **Đơn Hàng Đã Được Chỉnh Sửa!** (ID Mới: ...${orderId.slice(
                -6
              )})`
            : `🎉 **Có Đơn Hàng Mới!** (ID: ...${orderId.slice(-6)})`;

          const payload = {
            content: title,
            embeds: [
              {
                title: "Thông Tin Đơn Hàng",
                color: order.paymentStatus === "paid" ? 3066993 : 15105570,
                fields: fields,
                timestamp: new Date(
                  order.createdAt || Date.now()
                ).toISOString(),
              },
            ],
          };

          await fetch(DISCORD_WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
        } catch (error) {
          console.error("Lỗi gửi thông báo Discord:", error);
        }
      }

      // --- LOGIC MODAL CHỈNH SỬA ---

      function initializeEditWidget() {
        if (editUploadWidget) return;
        editUploadWidget = cloudinary.createUploadWidget(
          {
            cloudName: CLOUDINARY_CLOUD_NAME,
            uploadPreset: CLOUDINARY_UPLOAD_PRESET,
            multiple: true,
            folder: "user_uploads_edited",
            resourceType: "raw",
            imageMetadata: true,
            sources: ["local", "url"],
            clientAllowedFormats: [
              "pdf",
              "doc",
              "docx",
              "ppt",
              "pptx",
              "xls",
              "xlsx",
              "jpg",
              "png",
              "jpeg",
              "webp",
            ],
          },
          (error, result) => {
            if (!error && result && result.event === "success") {
              filesBeingEdited.push({
                docName: result.info.original_filename,
                cloudinaryUrl: result.info.secure_url,
                publicId: result.info.public_id,
                pages: result.info.pages || 1,
              });
              renderEditFileList();
              updateEditOrderCost();
            }
          }
        );
        document
          .getElementById("edit-upload-widget")
          .addEventListener("click", () => editUploadWidget.open(), false);
      }

      function openEditOrderModal(orderId) {
        const order = allOrders[orderId];
        if (!order) {
          showMessage("Lỗi", "Không tìm thấy đơn hàng.");
          return;
        }
        if (order.isPrinted || order.paymentStatus === "replaced") {
          showMessage(
            "Thông báo",
            "Không thể chỉnh sửa đơn hàng đã in hoặc đã bị thay thế."
          );
          return;
        }
        initializeEditWidget();
        document.getElementById("edit-order-id").value = orderId;
        document.getElementById("edit-order-user-id").value = order.userId;
        document.getElementById("edit-order-original-cost").value =
          order.totalCost;
        document.getElementById("edit-order-original-payment-status").value =
          order.paymentStatus;
        document.getElementById("edit-order-original-amount-paid").value =
          order.amountPaid || 0;
        filesBeingEdited = JSON.parse(JSON.stringify(order.items));
        const firstItem = order.items[0] || {};
        document.getElementById("edit-copies").value = firstItem.copies || 1;
        document.getElementById("edit-paper-size").value =
          firstItem.paperSize || "A4";
        document.getElementById("edit-print-type").value =
          firstItem.printType || "Thường";
        document.getElementById("edit-paper-type").value =
          firstItem.paperType || "A4";
        document.getElementById("edit-order-note").value = order.ghiChu || "";
        renderEditFileList();
        updateEditOrderCost();
        editOrderModal.style.display = "block";
      }

      function closeEditOrderModal() {
        editOrderModal.style.display = "none";
        editOrderForm.reset();
        filesBeingEdited = [];
      }

      document
        .getElementById("edit-order-modal-close")
        .addEventListener("click", closeEditOrderModal);

      function renderEditFileList() {
        editFileList.innerHTML = "";
        if (filesBeingEdited.length === 0) {
          editFileList.innerHTML =
            '<p class="text-sm text-gray-500 text-center">Đơn hàng rỗng. Vui lòng thêm file.</p>';
          return;
        }
        filesBeingEdited.forEach((file, index) => {
          const fileEl = document.createElement("div");
          fileEl.className =
            "flex items-center justify-between bg-gray-50 p-3 rounded-md border";
          let url = file.cloudinaryUrl || "#";
          let name = file.docName;
          if (!file.cloudinaryUrl && file.docId && allDocuments[file.docId]) {
            url = allDocuments[file.docId].url;
          }
          const fileUrl = getForcedDownloadLink(url, name);
          const downloadAttr = getDownloadAttribute(url, name);
          fileEl.innerHTML = `
                      <div class="flex-1 min-w-0 mr-4">
                          <a href="${fileUrl}" ${downloadAttr} target="_blank" rel="noopener noreferrer" class="text-sm font-medium text-blue-600 truncate" title="${file.docName}">${file.docName}</a>
                      </div>
                      <div class="flex items-center space-x-2 flex-shrink-0">
                          <label class="text-sm">Trang:</label>
                          <input type="number" class="w-16 p-1 border rounded-md text-sm edit-file-pages" min="1" value="${file.pages}" data-index="${index}">
                          <button type="button" class="remove-edit-file text-red-500 hover:text-red-700 font-bold text-lg" data-index="${index}">&times;</button>
                      </div>
                  `;
          editFileList.appendChild(fileEl);
        });
      }

      function updateEditOrderCost() {
        try {
          const copies =
            parseInt(document.getElementById("edit-copies").value) || 1;
          const printType = document.getElementById("edit-print-type").value;
          const paperType = document.getElementById("edit-paper-type").value;
          let totalPages = 0;
          filesBeingEdited.forEach((file) => {
            totalPages += parseInt(file.pages) || 0;
          });
          const total = calculateCost(totalPages, copies, printType, paperType);
          document.getElementById("edit-total-cost").textContent =
            formatCurrency(total);
          return total;
        } catch (e) {
          document.getElementById("edit-total-cost").textContent = "Lỗi";
          return 0;
        }
      }

      editOrderForm.addEventListener("change", (e) => {
        if (
          ["edit-copies", "edit-print-type", "edit-paper-type"].includes(
            e.target.id
          )
        ) {
          updateEditOrderCost();
        }
        if (e.target.classList.contains("edit-file-pages")) {
          const index = parseInt(e.target.dataset.index);
          let pages = parseInt(e.target.value) || 1;
          if (pages < 1) pages = 1;
          e.target.value = pages;
          filesBeingEdited[index].pages = pages;
          updateEditOrderCost();
        }
      });

      editFileList.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-edit-file")) {
          const index = parseInt(e.target.dataset.index);
          filesBeingEdited.splice(index, 1);
          renderEditFileList();
          updateEditOrderCost();
        }
      });

      editOrderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (filesBeingEdited.length === 0) {
          showMessage("Lỗi", "Đơn hàng phải có ít nhất 1 file.");
          return;
        }
        showLoading(true);
        try {
          const originalOrderId =
            document.getElementById("edit-order-id").value;
          const userId = document.getElementById("edit-order-user-id").value;
          const originalPaymentStatus = document.getElementById(
            "edit-order-original-payment-status"
          ).value;
          const originalAmountPaid = parseFloat(
            document.getElementById("edit-order-original-amount-paid").value
          );
          const originalOrder = allOrders[originalOrderId];
          if (!originalOrder) {
            throw new Error("Không tìm thấy đơn hàng gốc!");
          }
          if (
            originalOrder.isPrinted ||
            originalOrder.paymentStatus === "replaced"
          ) {
            throw new Error(
              "Không thể chỉnh sửa đơn hàng đã in hoặc đã bị thay thế."
            );
          }
          const copies = parseInt(document.getElementById("edit-copies").value);
          const paperSize = document.getElementById("edit-paper-size").value;
          const printType = document.getElementById("edit-print-type").value;
          const paperType = document.getElementById("edit-paper-type").value;
          const note = document.getElementById("edit-order-note").value.trim();
          const newTotalCost = updateEditOrderCost();
          const finalItems = filesBeingEdited.map((item) => ({
            docId: item.docId || null,
            docName: item.docName,
            cloudinaryUrl: item.cloudinaryUrl || null,
            publicId: item.publicId || null,
            pages: item.pages,
            copies: copies,
            paperSize: paperSize,
            printType: printType,
            paperType: paperType,
          }));
          const userRef = ref(db, `artifacts/${appId}/users/${userId}`);
          const userSnap = await get(userRef);
          let userBalance = userSnap.val()?.balance || 0;
          let refundAmount = 0;
          if (originalPaymentStatus === "paid") {
            refundAmount = originalAmountPaid;
            userBalance += refundAmount;
          }
          const newOrderDetails = {
            userId: userId,
            userName: originalOrder.userName,
            userClass: originalOrder.userClass,
            items: finalItems,
            totalCost: newTotalCost,
            timestamp: serverTimestamp(),
            createdAt: Date.now(),
            ghiChu: note,
            isPrinted: false,
          };
          if (userBalance >= newTotalCost) {
            userBalance -= newTotalCost;
            newOrderDetails.paymentStatus = "paid";
            newOrderDetails.amountPaid = newTotalCost;
            newOrderDetails.amountDue = 0;
          } else {
            newOrderDetails.paymentStatus = "pending";
            newOrderDetails.amountPaid = userBalance;
            newOrderDetails.amountDue = newTotalCost - userBalance;
            userBalance = 0;
          }
          await update(userRef, { balance: userBalance });
          const newOrderRef = push(ref(db, `artifacts/${appId}/public/orders`));
          await set(newOrderRef, newOrderDetails);
          const oldOrderRef = ref(
            db,
            `artifacts/${appId}/public/orders/${originalOrderId}`
          );
          await update(oldOrderRef, {
            paymentStatus: "replaced",
            isPrinted: true,
            ghiChu: `Đã được thay thế bởi đơn hàng mới (ID: ${
              newOrderRef.key
            }). Ghi chú gốc: ${originalOrder.ghiChu || ""}`.trim(),
          });
        
          sendDiscordNotification(newOrderDetails, newOrderRef.key, true);
          showMessage(
            "Thành Công",
            "Đã cập nhật đơn hàng. Một đơn hàng mới đã được tạo và đơn hàng cũ đã bị hủy."
          );
          closeEditOrderModal();
        } catch (error) {
          console.error("Lỗi lưu đơn hàng:", error);
          showMessage("Lỗi", `Không thể lưu thay đổi: ${error.message}`);
        } finally {
          showLoading(false);
        }
      });

      // --- EVENT LISTENERS CHUNG ---

      document.addEventListener("click", (e) => {
        const navLink = e.target.closest(".nav-link");
        if (navLink && navLink.dataset.view) {
          e.preventDefault();
          // Xóa kiểm tra currentUserData ở đây
          // vì showView sẽ tự kiểm tra quyền truy cập
          showView(navLink.dataset.view);
        }
      });

      appElement.addEventListener("click", (e) => {
        const viewBtn = e.target.closest(".view-order-details");
        if (viewBtn) {
          // THÊM: Check auth trước khi xem chi tiết
          if (!checkAuthAndShowLogin()) return;

          const orderId = viewBtn.dataset.orderId;
          const order = allOrders[orderId];
          if (order) {
            showOrderDetailsModal(order);
          }
          return;
        }
        const adminTab = e.target.closest(".admin-tab");
        if (adminTab && adminTab.dataset.tab) {
          e.preventDefault();
          switchAdminTab(adminTab.dataset.tab);
        }
      });

      // --- HÀM THAY THẾ CHO ALERT/CONFIRM/PROMPT ---

      function showConfirm(title, content) {
        return new Promise((resolve) => {
          const modal = document.createElement("div");
          modal.className =
            "view fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[10001]";
          modal.style.display = "block";
          modal.innerHTML = `
                      <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white mx-4 sm:mx-auto">
                          <div class="mt-3 text-center">
                              <h3 class="text-lg leading-6 font-medium text-gray-900">${title}</h3>
                              <div class="mt-2 px-7 py-3">
                                  <p class="text-sm text-gray-500">${content}</p>
                              </div>
                              <div class="items-center px-4 py-3 flex space-x-4">
                                  <button id="confirm-btn-cancel" class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none">Hủy</button>
                                  <button id="confirm-btn-ok" class="flex-1 px-4 py-2 bg-red-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-700 focus:outline-none">Đồng ý</button>
                              </div>
                          </div>
                      </div>
                  `;
          document.body.appendChild(modal);
          const close = (value) => {
            document.body.removeChild(modal);
            resolve(value);
          };
          modal
            .querySelector("#confirm-btn-ok")
            .addEventListener("click", () => close(true));
          modal
            .querySelector("#confirm-btn-cancel")
            .addEventListener("click", () => close(false));
        });
      }

      function showPrompt(title, content, defaultValue = "") {
        return new Promise((resolve) => {
          const modal = document.createElement("div");
          modal.className =
            "view fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-[10001]";
          modal.style.display = "block";
          modal.innerHTML = `
                      <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white mx-4 sm:mx-auto">
                          <form id="prompt-form" class="mt-3">
                              <h3 class="text-lg leading-6 font-medium text-gray-900 text-center">${title}</h3>
                              <div class="mt-2 px-7 py-3">
                                  <label class="text-sm text-gray-500 block whitespace-pre-wrap">${content}</label>
                                  <input type="text" id="prompt-input" class="mt-2 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="${defaultValue}">
                              </div>
                              <div class="items-center px-4 py-3 flex space-x-4">
                                  <button id="prompt-btn-cancel" type="button" class="flex-1 px-4 py-2 bg-gray-300 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-400 focus:outline-none">Hủy</button>
                                  <button id="prompt-btn-ok" type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none">OK</button>
                              </div>
                          </form>
                      </div>
                  `;
          document.body.appendChild(modal);
          const input = modal.querySelector("#prompt-input");
          input.focus();
          input.select();
          const close = (value) => {
            document.body.removeChild(modal);
            resolve(value);
          };
          modal
            .querySelector("#prompt-form")
            .addEventListener("submit", (e) => {
              e.preventDefault();
              close(input.value);
            });
          modal
            .querySelector("#prompt-btn-cancel")
            .addEventListener("click", () => close(null));
        });
      }

      // --- KHỞI CHẠY ỨNG DỤNG ---
      initializeAppLogic();
    </script>
  </body>
</html>


